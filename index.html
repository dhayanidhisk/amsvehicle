<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>AMS Driver App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            --gradient-blue: linear-gradient(135deg, #2196F3 0%, #1976D2 50%, #673AB7 100%);
            --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(56, 239, 125, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(56, 239, 125, 0.4);
            }

            50% {
                box-shadow: 0 0 40px rgba(56, 239, 125, 0.6);
            }
        }

        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .btn-gradient {
            background: var(--gradient-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-gradient:hover::before {
            left: 100%;
        }

        .btn-gradient:active {
            transform: scale(0.98);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }

        .gradient-border {
            position: relative;
            background: white;
            border-radius: 1rem;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 1rem;
            padding: 2px;
            background: var(--gradient-primary);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            /* Ensure minimum font size for inputs to prevent zoom on iOS */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Optimize glassmorphism for mobile performance */
            .glass,
            .glass-strong {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            /* Reduce animations on mobile for performance */
            .pulse-glow {
                animation: none;
                box-shadow: 0 0 20px rgba(56, 239, 125, 0.4);
            }

            /* Larger touch targets */
            button {
                min-height: 44px;
                min-width: 44px;
            }

            /* Optimize spacing for mobile */
            .p-6 {
                padding: 1rem !important;
            }

            .p-8 {
                padding: 1.5rem !important;
            }

            .p-10 {
                padding: 2rem !important;
            }

            .gap-6 {
                gap: 1rem !important;
            }

            /* Make modals more mobile-friendly */
            .max-w-md {
                max-width: calc(100vw - 2rem) !important;
            }

            /* Optimize header for mobile */
            header {
                padding: 1rem !important;
            }

            /* Better mobile navigation */
            nav {
                padding: 0.5rem !important;
            }
        }

        /* Disable hover effects on touch devices */
        @media (hover: none) {
            .hover-lift:hover {
                transform: none;
            }

            .btn-gradient:hover::before {
                left: -100%;
            }
        }

        /* Safe area support for notched phones */
        @supports (padding: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
            }
        }

        /* Prevent text selection on buttons for better mobile UX */
        button {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Optimize for small screens */
        @media (max-width: 375px) {
            h1 {
                font-size: 1.25rem !important;
            }

            h2 {
                font-size: 1.125rem !important;
            }

            h3 {
                font-size: 1rem !important;
            }

            .text-4xl {
                font-size: 1.875rem !important;
            }

            .text-3xl {
                font-size: 1.5rem !important;
            }

            .text-2xl {
                font-size: 1.25rem !important;
            }

            .text-xl {
                font-size: 1.125rem !important;
            }
        }
    </style>
</head>

<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col relative pb-20" style="position: relative; z-index: 1;">
        <div id="loading-screen"
            class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-500"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="flex flex-col items-center gap-6 scale-in">
                <div class="relative">
                    <div class="absolute inset-0 animate-ping rounded-full bg-white opacity-20"></div>
                    <div class="relative w-20 h-20 rounded-full glass-dark flex items-center justify-center">
                        <i class="ph-fill ph-truck text-4xl text-white"></i>
                    </div>
                </div>
                <div class="text-center">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                    <p class="text-white text-base font-semibold">Connecting Driver App...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modals"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, setDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1YRKvTHkK0QNMEdxfWbNCrKSWRzVOxdg",
            authDomain: "ams-service-f923f.firebaseapp.com",
            projectId: "ams-service-f923f",
            storageBucket: "ams-service-f923f.firebasestorage.app",
            messagingSenderId: "31368661696",
            appId: "1:31368661696:web:61b78217d78ed9cec8fb25",
            measurementId: "G-C0JVW9GMZJ"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ams-towing-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const DRIVERS = {
            '6380664123': { name: 'Nandha Kumar', phone: '6380664123' },
            '8973475204': { name: 'Vignesh Kumar', phone: '8973475204' },
            '9080180377': { name: 'Madhan', phone: '9080180377' },
            '9751204576': { name: 'Dinesh', phone: '9751204576' },
            '9042160596': { name: 'Nasarjun', phone: '9042160596' }
        };
        const TRUCK_NUMBERS = ['TN 38 DJ 6740', 'TN 38 DM 4315', 'TN 38 DR 1843'];
        const LOCATIONS = ['Coimbatore', 'Tiruppur', 'Erode', 'Ooty', 'Pollachi'];
        const TOYOTA_MODELS = ['Innova Crysta', 'Innova Hycross', 'Fortuner', 'Legender', 'Glanza', 'Urban Cruiser Hyryder', 'Rumion', 'Taisor', 'Camry', 'Vellfire', 'Hilux', 'Etios', 'Corolla Altis', 'Yaris', 'Urban Cruiser', 'Land Cruiser 300'];
        const CATEGORIES = { NEW: ['TVS', 'INT', 'FREE'], BREAKDOWN: ['TVS', 'Service', 'Others'], EMPTY: [] };

        window.state = {
            user: null,
            view: 'login',
            driverTab: 'home',
            activeTrip: null,
            shiftStatus: 'offline',
            trips: [],
            monthlyAttendance: [],
            leaveRequests: [],
            isContinuedSession: false,
            lastTripData: null,
            form: { truck: '', date: new Date().toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' },
            form: { truck: '', date: new Date().toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' },
            modal: null,
            darkMode: false
        };

        // Initialize Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            window.state.darkMode = true;
        }

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            render();
        };

        const state = window.state;
        const appDiv = document.getElementById('app');
        const modalDiv = document.getElementById('modals');
        const loadingScreen = document.getElementById('loading-screen');

        const formatTime = (ts) => { if (!ts) return '--:--'; const date = ts.toDate ? ts.toDate() : new Date(ts); return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); };
        const formatDate = (ts) => { if (!ts) return '--/--'; const date = ts.toDate ? ts.toDate() : new Date(ts); return date.toLocaleDateString(); };

        const initAuth = async () => {
            try {
                let signedIn = false;
                // 1. Try Custom Token if available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        signedIn = true;
                    } catch (e) {
                        console.warn("Custom token mismatch, falling back to anonymous auth");
                    }
                }

                // 2. Fallback to Anonymous
                if (!signedIn) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Failed", error);
                loadingScreen.innerHTML = `<div class="text-white text-center p-4"><p class="font-bold mb-2">Connection Error</p><p class="text-xs text-slate-300">${error.code || error.message}</p></div>`;
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                if (!state.user) render();
            }
        });

        let unsubscribers = [];

        const setupListeners = () => {
            if (!state.user) return;
            const today = new Date().toISOString().split('T')[0];
            const docId = `${today}_${state.user.name}`;

            unsubscribers.push(onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'ams_attendance', docId), (s) => {
                state.shiftStatus = s.exists() ? s.data().status : 'offline';
                render();
            }));

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(q, (s) => {
                const allTrips = s.docs.map(d => ({ id: d.id, ...d.data() }));
                allTrips.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.trips = allTrips;
                state.activeTrip = allTrips.find(t => t.status === 'active') || null;
                if (state.activeTrip && (state.modal === 'startTrip' || state.modal === 'postTrip')) state.modal = null;
                render();
            }));

            const attQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(attQ, (s) => { state.monthlyAttendance = s.docs.map(d => d.data()); render(); }));

            const leaveQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(leaveQ, (s) => { state.leaveRequests = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); render(); }));
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) await initAuth();
            const phone = document.getElementById('login-phone').value.trim();
            if (DRIVERS[phone]) {
                const driver = DRIVERS[phone];
                state.user = { name: driver.name, role: 'driver', phone: driver.phone };
                state.view = 'driver';
                setupListeners();
            } else alert('Invalid Phone Number');
            render();
            return false;
        };

        window.handleLogout = () => {
            state.user = null; state.view = 'login'; state.activeTrip = null; state.trips = [];
            unsubscribers.forEach(u => u()); unsubscribers = [];
            render();
        };

        window.toggleShift = async () => {
            const today = new Date().toISOString().split('T')[0];
            const docId = `${today}_${state.user.name}`;
            const newStatus = state.shiftStatus === 'online' ? 'offline' : 'online';
            const data = { driverId: state.user.phone, driverName: state.user.name, driverPhone: state.user.phone, date: today, status: newStatus, lastUpdated: serverTimestamp() };
            const payload = newStatus === 'online' ? { ...data, checkInTime: serverTimestamp() } : { ...data, checkOutTime: serverTimestamp() };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_attendance', docId), payload, { merge: true });
        };

        window.openStartTripModal = (e) => {
            e.preventDefault();
            const f = state.form;
            if (!f.truck || !f.date || (!f.pickup && !f.pickupOther) || (!f.drop && !f.dropOther)) return alert("Please fill Truck, Date, Pickup and Drop.");
            // Initialize terms data
            state.termsData = {
                beltCondition: false,
                deliveryChallan: '',
                invoiceCopy: '',
                t2WayBill: '',
                lorryReceipt: ''
            };
            state.modal = 'termsConditions';
            render();
            return false;
        };

        window.acceptTerms = () => {
            const td = state.termsData;
            // Validate all fields are filled
            if (!td.beltCondition) return alert("Please confirm Belt Condition");
            if (!td.deliveryChallan || !td.invoiceCopy || !td.t2WayBill || !td.lorryReceipt) {
                return alert("Please fill all document fields (Yes/No/NA)");
            }
            state.modal = 'startTrip';
            render();
        };

        window.updateTerms = (field, val) => {
            state.termsData[field] = val;
            render();
        };

        window.confirmStartTrip = async () => {
            const odo = document.getElementById('start-odo').value;
            if (!odo) return;
            if (parseFloat(odo) <= 0) return alert("Please enter a valid positive odometer reading.");
            if (odo.length !== 6) return alert("Odometer reading must be exactly 6 digits.");
            const f = state.form;
            const pickup = f.pickup === 'Other' ? f.pickupOther : f.pickup;
            const drop = f.drop === 'Other' ? f.dropOther : f.drop;
            const model = f.model === 'Other' ? f.modelOther : f.model;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'), {
                    driverName: state.user.name, truckNumber: f.truck, date: f.date, pickupLocation: pickup, dropLocation: drop,
                    tripCategory: f.cat, tripType: f.cat === 'Empty' ? 'Empty' : f.type, customerName: f.customer || null,
                    vehicleModel: f.cat === 'Empty' ? null : model, vehicleNumber: f.cat === 'Empty' ? null : f.vehicleNo,
                    startOdo: odo, status: 'active', startTime: serverTimestamp(), createdAt: serverTimestamp(),
                    // Terms and Conditions data
                    termsAccepted: true,
                    beltCondition: state.termsData.beltCondition,
                    deliveryChallan: state.termsData.deliveryChallan,
                    invoiceCopy: state.termsData.invoiceCopy,
                    t2WayBill: state.termsData.t2WayBill,
                    lorryReceipt: state.termsData.lorryReceipt
                });
                state.modal = null; render();
            } catch (error) {
                console.error("Error starting trip:", error);
                alert("Failed to start trip. Please check your connection and try again.\nError: " + error.message);
            }
        };

        window.confirmStopTrip = async () => {
            const odo = document.getElementById('end-odo').value;
            if (!odo) return;
            if (odo.length !== 6) return alert("Odometer reading must be exactly 6 digits.");
            if (state.activeTrip && parseFloat(odo) <= parseFloat(state.activeTrip.startOdo)) {
                return alert(`End Odometer (${odo}) must be greater than Start Odometer (${state.activeTrip.startOdo})`);
            }
            if (!state.activeTrip) {
                return alert("Error: Active trip data missing. Please refresh the page and try again.");
            }
            // Capture values BEFORE async call, because onSnapshot might clear state.activeTrip when status changes to 'completed'
            const currentDrop = state.activeTrip.dropLocation;
            const currentPickup = state.activeTrip.pickupLocation;
            const currentTruck = state.activeTrip.truckNumber;
            const tripId = state.activeTrip.id;

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), { endTime: serverTimestamp(), endOdo: odo, status: 'completed' });
                state.lastTripData = { dropLocation: currentDrop, pickupLocation: currentPickup, truckNumber: currentTruck, endOdo: odo };
                state.modal = 'postTrip';
                render();
            } catch (error) {
                console.error("Error stopping trip:", error);
                alert("Failed to stop trip. Please check your connection and try again.\nError: " + error.message);
            }
        };

        window.openTripOptions = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.lastTripData = { dropLocation: trip.dropLocation, pickupLocation: trip.pickupLocation, truckNumber: trip.truckNumber, endOdo: trip.endOdo };
            state.isContinuedSession = true; // Set to true to allow return trip logic to work
            state.modal = 'postTrip';
            render();
        };

        window.handleReturnTrip = () => {
            state.isContinuedSession = true; state.modal = null;
            const lastDrop = state.lastTripData?.dropLocation || '';
            const lastPickup = state.lastTripData?.pickupLocation || '';

            const isStdDrop = LOCATIONS.includes(lastDrop);
            const isStdPickup = LOCATIONS.includes(lastPickup);

            // Swap locations: New Pickup = Old Drop, New Drop = Old Pickup
            state.form.pickup = isStdDrop ? lastDrop : 'Other';
            state.form.pickupOther = isStdDrop ? '' : lastDrop;

            state.form.drop = isStdPickup ? lastPickup : 'Other';
            state.form.dropOther = isStdPickup ? '' : lastPickup;

            state.form.cat = 'New'; state.form.type = 'TVS';
            state.form.model = ''; state.form.vehicleNo = ''; state.form.customer = '';
            render();
        };

        window.handleContinueSession = () => {
            state.isContinuedSession = true; state.modal = null;
            const lastDrop = state.lastTripData?.dropLocation || ''; const isStdLoc = LOCATIONS.includes(lastDrop);
            state.form.pickup = isStdLoc ? lastDrop : 'Other'; state.form.pickupOther = isStdLoc ? '' : lastDrop;
            state.form.truck = state.lastTripData?.truckNumber || '';
            state.form.drop = ''; state.form.dropOther = ''; state.form.cat = 'New'; state.form.type = 'TVS';
            state.form.model = ''; state.form.vehicleNo = ''; state.form.customer = '';
            render();
        };

        window.handleEndDuty = () => {
            state.isContinuedSession = false; state.lastTripData = null; state.modal = null;
            state.form = { truck: '', date: new Date().toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' };
            render();
        };

        window.submitLeave = async (e) => {
            e.preventDefault();
            const start = document.getElementById('leave-start').value;
            const end = document.getElementById('leave-end').value;
            const reason = document.getElementById('leave-reason').value;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'), {
                driverName: state.user.name, driverPhone: state.user.phone, startDate: start, endDate: end, reason: reason, status: 'pending', createdAt: serverTimestamp()
            });
            state.modal = null; render();
            return false;
        };

        // Debounce render to avoid UI flicker on rapid updates
        let renderTimeout = null;
        const scheduleRender = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                render();
                renderTimeout = null;
            }, 150);
        };

        // Updated updateForm to use scheduleRender for fields that need UI update
        window.updateForm = (field, val) => {
            state.form[field] = val;
            const fieldsRequiringRender = ['truck', 'date', 'pickup', 'drop', 'cat', 'type', 'model'];
            if (fieldsRequiringRender.includes(field)) {
                scheduleRender();
            }
        };

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="glass-strong rounded-3xl shadow-2xl p-10 w-full max-w-md text-center hover-lift" style="box-shadow: var(--shadow-xl);">
                    <div class="relative mb-8">
                        <div class="absolute inset-0 blur-2xl opacity-30" style="background: var(--gradient-primary);"></div>
                        <div class="relative w-24 h-24 rounded-3xl flex items-center justify-center mx-auto shadow-2xl" style="background: var(--gradient-blue);">
                            <i class="ph-fill ph-steering-wheel text-5xl text-white"></i>
                        </div>
                    </div>
                    <h1 class="text-4xl font-bold mb-2" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Driver Login</h1>
                    <p class="text-slate-600 mb-10 text-lg font-medium">AMS Towing Service</p>
                    <form onsubmit="return handleLogin(event)" class="space-y-6">
                        <div class="relative group">
                            <i class="ph ph-phone absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl transition-colors group-focus-within:text-purple-600"></i>
                            <input type="tel" id="login-phone" class="w-full pl-12 pr-4 py-4 bg-white border-2 border-slate-200 rounded-2xl text-lg transition-all" placeholder="Enter Phone Number" required pattern="[0-9]{10}" maxlength="10" style="box-shadow: var(--shadow-sm);">
                        </div>
                        <button type="submit" class="w-full py-5 text-white rounded-2xl font-bold text-lg shadow-xl relative overflow-hidden btn-gradient">
                            <span class="relative z-10 flex items-center justify-center gap-2">
                                <i class="ph-bold ph-sign-in"></i>
                                Start Shift
                            </span>
                        </button>
                    </form>
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <p class="text-xs text-slate-400 font-medium">Authorized Personnel Only</p>
                    </div>
                </div>
            </div>`;

        const renderHome = () => {
            const todaysHistory = state.trips.filter(t => t.date === new Date().toISOString().split('T')[0] && t.status === 'completed');
            return `
            <div class="space-y-6">
                <div class="relative rounded-2xl overflow-hidden ${state.shiftStatus === 'online' ? 'pulse-glow' : ''}" style="box-shadow: var(--shadow-lg);">
                    <div class="glass-strong p-6 relative">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Duty Status</p>
                                <div class="flex items-center gap-3">
                                    ${state.shiftStatus === 'online' ? `
                                        <span class="relative flex h-4 w-4">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-4 w-4 bg-green-500"></span>
                                        </span>
                                        <span class="text-2xl font-bold" style="background: var(--gradient-green); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ON DUTY</span>
                                    ` : `
                                        <div class="h-4 w-4 rounded-full bg-slate-400"></div>
                                        <span class="text-2xl font-bold text-slate-500">OFF DUTY</span>
                                    `}
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="toggleShift()" ${state.activeTrip ? 'disabled' : ''} class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${state.shiftStatus === 'online' ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg' : 'btn-gradient text-white shadow-lg'} ${state.activeTrip ? 'opacity-50 cursor-not-allowed' : 'hover-lift'}" style="${!state.activeTrip ? 'box-shadow: var(--shadow-md);' : ''}">
                            <i class="ph-bold ph-power text-lg"></i> 
                            ${state.shiftStatus === 'online' ? 'End Shift' : 'Start Shift'}
                        </button>
                    </div>
                    ${state.shiftStatus === 'online' ? '<div class="absolute top-0 left-0 right-0 h-1" style="background: var(--gradient-green);"></div>' : ''}
                </div>
                ${state.activeTrip ? renderActiveTrip() : renderNewTripForm()}
                <div class="glass-strong rounded-2xl p-6 dark:bg-slate-800 dark:border dark:border-slate-700 transition-colors" style="box-shadow: var(--shadow-md);">
                    <h3 class="text-sm font-bold text-slate-600 dark:text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="ph-fill ph-clock-clockwise text-purple-600 dark:text-purple-400"></i>
                        Today's History
                    </h3>
                    <div class="space-y-3">
                        ${todaysHistory.length === 0 ? '<div class="text-center py-8"><i class="ph-fill ph-package text-4xl text-slate-300 dark:text-slate-600 mb-2 block"></i><p class="text-slate-400 dark:text-slate-500 italic text-sm">No trips completed yet</p></div>' : ''}
                        ${todaysHistory.map((t, index) => `
                            <div class="glass p-4 rounded-xl hover-lift dark:bg-slate-700 dark:border-slate-600 transition-colors" style="box-shadow: var(--shadow-sm);">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-800 dark:text-slate-100 mb-1">${t.vehicleModel || 'Empty'} 
                                            <span class="text-slate-400 dark:text-slate-400 font-normal text-xs ml-1">${t.vehicleNumber || ''}</span>
                                        </div>
                                        <div class="text-xs text-slate-500 dark:text-slate-300 flex items-center gap-1">
                                            <i class="ph-fill ph-map-pin text-purple-600 dark:text-purple-400"></i> 
                                            ${t.pickupLocation} 
                                            <i class="ph-bold ph-arrow-right"></i> 
                                            ${t.dropLocation}
                                        </div>
                                    </div>
                                    <div class="text-right ml-4">
                                        <span class="block font-mono font-semibold text-slate-700 dark:text-slate-300 text-xs mb-1">${t.truckNumber}</span>
                                        ${index === 0 ? `<button onclick="openTripOptions('${t.id}')" class="px-3 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 text-[10px] font-bold rounded-lg hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">Options</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        };

        const renderActiveTrip = () => `
            <div class="glass-strong rounded-2xl overflow-hidden" style="box-shadow: var(--shadow-xl);">
                <div class="relative p-5 text-white overflow-hidden" style="background: var(--gradient-success);">
                    <div class="absolute inset-0 opacity-20" style="background: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;0.4&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                    <div class="relative flex justify-between items-center">
                        <h2 class="font-bold text-xl flex items-center gap-2">
                            <i class="ph-fill ph-navigation-arrow text-2xl"></i> 
                            Trip in Progress
                        </h2>
                        <div class="glass-dark px-3 py-1.5 rounded-lg">
                            <span class="text-sm font-mono font-semibold">${formatTime(state.activeTrip.startTime)}</span>
                        </div>
                    </div>
                </div>
                <div class="p-6 space-y-5">
                    <div>
                        <h3 class="text-2xl font-bold mb-1" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ${state.activeTrip.vehicleModel || 'Empty Run'}
                        </h3>
                        <p class="text-slate-500 font-medium">${state.activeTrip.vehicleNumber || 'No vehicle number'}</p>
                    </div>
                    <div class="glass p-5 rounded-xl" style="box-shadow: var(--shadow-sm);">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1.5">Pickup Location</p>
                                <p class="font-semibold text-slate-800 text-sm">${state.activeTrip.pickupLocation}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--gradient-primary);">
                                    <i class="ph-bold ph-arrow-right text-white text-lg"></i>
                                </div>
                            </div>
                            <div class="flex-1 text-right">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1.5">Drop Location</p>
                                <p class="font-semibold text-slate-800 text-sm">${state.activeTrip.dropLocation}</p>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="state.modal='stopTrip'; render()" class="w-full py-4 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-xl relative overflow-hidden transition-all hover-lift" style="background: var(--gradient-danger);">
                        <i class="ph-bold ph-stop-circle text-2xl"></i> 
                        Stop Trip
                    </button>
                </div>
            </div>`;

        const renderNewTripForm = () => {
            if (state.shiftStatus === 'offline') return `<div class="py-12 px-4 bg-slate-100 dark:bg-slate-800 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 text-center transition-colors"><i class="ph-fill ph-wifi-slash text-3xl text-slate-400 mb-4 block"></i><h3 class="text-lg font-bold text-slate-600 dark:text-slate-300">You are Off Duty</h3><p class="text-slate-400 dark:text-slate-500 text-sm mt-2">Go ON DUTY to start logging.</p></div>`;
            const f = state.form;
            return `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 transition-colors"><h2 class="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-play-circle text-blue-600 dark:text-blue-400 text-2xl"></i> ${state.isContinuedSession ? 'Continue Duty' : 'Start New Trip'}</h2><form onsubmit="return openStartTripModal(event)" class="space-y-5"><div class="grid grid-cols-2 gap-4"><select onchange="updateForm('truck', this.value)" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-lg outline-none" required ${state.isContinuedSession ? 'disabled' : ''}><option value="">Select Truck</option>${TRUCK_NUMBERS.map(t => `<option value="${t}" ${f.truck === t ? 'selected' : ''}>${t}</option>`).join('')}</select><input type="date" value="${f.date}" oninput="updateForm('date', this.value)" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-lg outline-none" required ${state.isContinuedSession ? 'disabled' : ''}></div><div class="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-100 dark:border-slate-800 space-y-3">${state.isContinuedSession ? '<div class="text-xs text-blue-600 dark:text-blue-400"><i class="ph-bold ph-check"></i> Pickup auto-filled</div>' : ''}<div><select onchange="updateForm('pickup', this.value)" class="w-full p-2.5 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required><option value="">Pickup</option>${LOCATIONS.map(l => `<option value="${l}" ${f.pickup === l ? 'selected' : ''}>${l}</option>`).join('')}<option value="Other" ${f.pickup === 'Other' ? 'selected' : ''}>Other...</option></select>${f.pickup === 'Other' ? `<input type="text" value="${f.pickupOther}" oninput="updateForm('pickupOther', this.value)" placeholder="Enter Pickup" class="w-full mt-2 p-2.5 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required>` : ''}</div><div><select onchange="updateForm('drop', this.value)" class="w-full p-2.5 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required><option value="">Drop</option>${LOCATIONS.map(l => `<option value="${l}" ${f.drop === l ? 'selected' : ''}>${l}</option>`).join('')}<option value="Other" ${f.drop === 'Other' ? 'selected' : ''}>Other...</option></select>${f.drop === 'Other' ? `<input type="text" value="${f.dropOther}" oninput="updateForm('dropOther', this.value)" placeholder="Enter Drop" class="w-full mt-2 p-2.5 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required>` : ''}</div></div><div><label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 block">Category</label><div class="grid grid-cols-3 gap-2">${Object.keys(CATEGORIES).map(k => `<button type="button" onclick="updateForm('cat', '${CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break Down')}'); updateForm('type', '${CATEGORIES[k][0] || ''}')" class="py-2 rounded-lg text-sm font-bold border transition-all ${f.cat === (CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break Down')) ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400'}">${CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break')}</button>`).join('')}</div></div>${f.cat !== 'Empty' ? `<div class="space-y-4"><div class="flex flex-wrap gap-2">${(f.cat === 'New' ? CATEGORIES.NEW : CATEGORIES.BREAKDOWN).map(t => `<button type="button" onclick="updateForm('type', '${t}')" class="px-3 py-1 rounded-full text-xs font-bold border dark:border-slate-600 ${f.type === t ? 'bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-900' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}">${t}</button>`).join('')}</div>${(f.cat === 'Break Down' && (f.type === 'Service' || f.type === 'Others')) ? `<input type="text" value="${f.customer}" oninput="updateForm('customer', this.value)" placeholder="Customer Name" class="w-full p-3 bg-white dark:bg-slate-800 border border-amber-300 dark:border-amber-700 rounded-lg outline-none dark:text-white" required>` : ''}<div class="grid grid-cols-2 gap-4"><div><select onchange="updateForm('model', this.value)" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required><option value="">Model</option>${TOYOTA_MODELS.map(m => `<option value="${m}" ${f.model === m ? 'selected' : ''}>${m}</option>`).join('')}<option value="Other" ${f.model === 'Other' ? 'selected' : ''}>Other...</option></select>${f.model === 'Other' ? `<input type="text" value="${f.modelOther}" oninput="updateForm('modelOther', this.value)" placeholder="Name" class="w-full mt-2 p-2 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-lg text-sm" required>` : ''}</div><input type="text" value="${f.vehicleNo}" oninput="updateForm('vehicleNo', this.value.toUpperCase())" placeholder="ABC-1234" class="w-full p-3 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-lg uppercase text-sm" required></div></div>` : ''}<button type="submit" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all mt-4">Next <i class="ph-bold ph-arrow-right"></i></button></form></div>`;
        };


        const renderCalendar = (records, trips) => {
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const attMap = {}; records.forEach(r => attMap[r.date] = r.status);
            const tripCountMap = {}; trips.forEach(t => { if (t.status === 'completed' && t.date.startsWith(now.toISOString().slice(0, 7))) tripCountMap[t.date] = (tripCountMap[t.date] || 0) + 1; });
            let cal = '<div class="grid grid-cols-7 gap-1 mt-4">';
            for (let i = 1; i <= daysInMonth; i++) {
                const d = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                cal += `<div class="aspect-square flex flex-col items-center justify-center rounded-lg text-xs ${attMap[d] === 'online' ? 'bg-green-100 text-green-700 font-bold border border-green-200' : 'bg-slate-100 text-slate-400'} relative">${i}${tripCountMap[d] > 0 ? `<span class="absolute top-0 right-0 h-4 w-4 bg-blue-600 text-white text-[9px] flex items-center justify-center rounded-full -mt-1 -mr-1 shadow-sm font-bold">${tripCountMap[d]}</span>` : ''}</div>`;
            }
            return cal + '</div>';
        };

        const renderAttendance = () => `<div class="space-y-6"><div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div class="flex justify-between items-center mb-2"><h2 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-600"></i> Report</h2></div>${renderCalendar(state.monthlyAttendance, state.trips)}</div><button type="button" onclick="state.modal='applyLeave'; render()" class="w-full py-4 bg-amber-500 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="ph-bold ph-file-text"></i> Apply for Leave</button><div><h3 class="text-sm font-bold text-slate-500 uppercase mb-3">Requests</h3><div class="space-y-3">${state.leaveRequests.map(r => `<div class="bg-white border p-3 rounded-xl flex justify-between items-center"><div><div class="text-sm font-bold text-slate-700">${r.startDate} <span class="text-slate-400">to</span> ${r.endDate}</div><div class="text-xs text-slate-500 italic">${r.reason}</div></div><div><span class="px-2 py-1 rounded-lg text-xs font-bold ${r.status === 'approved' ? 'bg-green-100 text-green-700' : (r.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700')}">${r.status.toUpperCase()}</span></div></div>`).join('')}</div></div></div>`;

        const renderModals = () => {
            if (!state.modal) return '';
            let content = '';
            if (state.modal === 'termsConditions') {
                const td = state.termsData || {};
                content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-warning);">
                        <i class="ph-fill ph-clipboard-text text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2" style="background: var(--gradient-warning); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Terms & Conditions</h3>
                    <p class="text-slate-600 text-sm">Tap to confirm status</p>
                </div>
                <div class="space-y-5 mb-6">
                    <button type="button" onclick="updateTerms('beltCondition', !state.termsData.beltCondition)" class="w-full p-4 rounded-xl flex items-center gap-4 transition-all ${td.beltCondition ? 'bg-green-100 border-2 border-green-500 text-green-800' : 'bg-slate-50 border-2 border-slate-200 text-slate-500'}" style="box-shadow: var(--shadow-sm);">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${td.beltCondition ? 'border-green-600 bg-green-600 text-white' : 'border-slate-300'}">
                            ${td.beltCondition ? '<i class="ph-bold ph-check text-sm"></i>' : ''}
                        </div>
                        <span class="font-bold text-lg">Belt Condition Checked</span>
                    </button>

                    <div class="space-y-4">
                        ${['deliveryChallan', 'invoiceCopy', 't2WayBill', 'lorryReceipt'].map(field => `
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-bold text-slate-700 capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}</label>
                                    ${td[field] ? `<span class="text-xs font-bold px-2 py-0.5 rounded ${td[field] === 'Yes' ? 'bg-green-100 text-green-700' : (td[field] === 'No' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600')}">${td[field]}</span>` : ''}
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    ${['Yes', 'No', 'NA'].map(opt => `
                                        <button type="button" onclick="updateTerms('${field}', '${opt}')" class="py-3 px-2 rounded-lg text-sm font-bold border-2 transition-all ${td[field] === opt ? (opt === 'Yes' ? 'border-green-500 bg-green-50 text-green-700' : (opt === 'No' ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-400 bg-slate-100 text-slate-700')) : 'border-slate-100 bg-white text-slate-400 hover:border-slate-200'}">
                                            ${opt}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                    <button type="button" onclick="acceptTerms()" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-warning); box-shadow: var(--shadow-md);">I Agree</button>
                </div>`;
            }
            else if (state.modal === 'startTrip') content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-primary);">
                        <i class="ph-fill ph-gauge text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Start Odometer</h3>
                    ${state.isContinuedSession ? '<p class="text-xs text-purple-600 mt-2 font-semibold"><i class="ph-bold ph-check"></i> Auto-filled from last trip</p>' : ''}
                </div>
                <input type="number" id="start-odo" value="${state.isContinuedSession ? (state.lastTripData?.endOdo || '') : ''}" class="w-full p-5 border-2 border-purple-200 rounded-2xl text-3xl text-center mb-6 font-bold" placeholder="123456" autofocus style="box-shadow: var(--shadow-sm);">
                <div class="flex gap-3">
                    <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                    <button type="button" onclick="confirmStartTrip()" class="flex-1 py-3 text-white rounded-xl font-bold btn-gradient" style="box-shadow: var(--shadow-md);">Confirm</button>
                </div>`;
            else if (state.modal === 'stopTrip') content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-danger);">
                        <i class="ph-fill ph-stop-circle text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold" style="background: var(--gradient-danger); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">End Odometer</h3>
                </div>
                <input type="number" id="end-odo" class="w-full p-5 border-2 border-red-200 rounded-2xl text-3xl text-center mb-6 font-bold" placeholder="123456" autofocus style="box-shadow: var(--shadow-sm);">
                <div class="flex gap-3">
                    <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                    <button type="button" onclick="confirmStopTrip()" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-danger); box-shadow: var(--shadow-md);">Stop Trip</button>
                </div>`;
            else if (state.modal === 'postTrip') content = `
                <div class="text-center">
                    <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-green);">
                        <i class="ph-bold ph-check text-4xl text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2" style="background: var(--gradient-green); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Trip Completed!</h2>
                    <p class="text-slate-500 mb-6">What would you like to do next?</p>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button type="button" onclick="handleContinueSession()" class="py-4 text-white rounded-xl font-bold btn-gradient flex flex-col items-center justify-center gap-1" style="box-shadow: var(--shadow-md);"><i class="ph-bold ph-arrow-clockwise text-xl"></i> Continue Trip</button>
                        <button type="button" onclick="handleReturnTrip()" class="py-4 text-white rounded-xl font-bold flex flex-col items-center justify-center gap-1" style="background: var(--gradient-secondary); box-shadow: var(--shadow-md);"><i class="ph-bold ph-arrows-left-right text-xl"></i> Return Trip</button>
                    </div>
                    <button type="button" onclick="handleEndDuty()" class="w-full py-4 text-white rounded-xl font-bold transition-all hover-lift" style="background: var(--gradient-green); box-shadow: var(--shadow-md);"><i class="ph-bold ph-check-circle"></i> End Trip</button>
                </div>`;
            else if (state.modal === 'applyLeave') content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-warning);">
                        <i class="ph-fill ph-calendar-x text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold" style="background: var(--gradient-warning); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Apply for Leave</h3>
                </div>
                <form onsubmit="return submitLeave(event)" class="space-y-4">
                    <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">From Date</label><input type="date" id="leave-start" class="w-full p-3 border-2 border-slate-200 rounded-xl mt-1" required style="box-shadow: var(--shadow-sm);"></div>
                    <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">To Date</label><input type="date" id="leave-end" class="w-full p-3 border-2 border-slate-200 rounded-xl mt-1" required style="box-shadow: var(--shadow-sm);"></div>
                    <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Reason</label><textarea id="leave-reason" class="w-full p-3 border-2 border-slate-200 rounded-xl h-24 mt-1" required style="box-shadow: var(--shadow-sm);"></textarea></div>
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                        <button type="submit" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-warning); box-shadow: var(--shadow-md);">Submit</button>
                    </div>
                </form>`;
            return `<div class="fixed inset-0 z-40 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);"><div class="glass-strong rounded-3xl p-8 w-full max-w-md" style="box-shadow: var(--shadow-xl);">${content}</div></div>`;
        };

        window.render = () => {
            modalDiv.innerHTML = renderModals();
            if (!state.user) { appDiv.innerHTML = renderLogin(); return; }
            appDiv.innerHTML = `
                <header class="text-white p-5 sticky top-0 z-10 flex justify-between items-center glass-dark backdrop-blur-md" style="background: var(--gradient-blue); box-shadow: var(--shadow-lg);">
                    <div class="flex items-center gap-3">
                        <div class="glass-dark p-2.5 rounded-xl">
                            <i class="ph-fill ph-truck text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="font-bold text-xl">Driver Panel</h1>
                            <p class="text-xs text-blue-100 font-medium opacity-90 flex items-center gap-1"><i class="ph-bold ph-user"></i> ${state.user.name}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl glass-dark flex items-center justify-center hover:bg-white/20 transition-all active:scale-95">
                            <i class="ph-fill ${state.darkMode ? 'ph-sun text-amber-300' : 'ph-moon-stars text-blue-100'} text-xl"></i>
                        </button>
                        <button onclick="handleLogout()" class="w-10 h-10 rounded-xl glass-dark flex items-center justify-center hover:bg-red-500/20 transition-all active:scale-95">
                            <i class="ph-bold ph-power text-xl"></i>
                        </button>
                    </div>
                </header>
                
                <main class="max-w-3xl mx-auto p-4 w-full min-h-screen pb-24 transition-colors duration-300 dark:bg-slate-900">
                    ${state.driverTab === 'home' ? renderHome() : renderAttendance()}
                </main>

                <nav class="fixed bottom-0 left-0 right-0 glass-strong dark:bg-slate-800/90 dark:border-t dark:border-slate-700 p-3 flex justify-around items-center z-20 pb-safe transition-all" style="box-shadow: 0 -4px 16px rgba(0,0,0,0.1);">
                    <button type="button" onclick="state.driverTab='home'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'home' ? 'scale-in' : ''}" style="${state.driverTab === 'home' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'home' ? 'color: #94a3b8;' : ''}">
                        <i class="ph-fill ph-house text-2xl"></i>
                        <span class="text-[10px] font-bold">Home</span>
                    </button>
                    <button type="button" onclick="state.driverTab='attendance'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'attendance' ? 'scale-in' : ''}" style="${state.driverTab === 'attendance' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'attendance' ? 'color: #94a3b8;' : ''}">
                        <i class="ph-fill ph-calendar-check text-2xl"></i>
                        <span class="text-[10px] font-bold">Status</span>
                    </button>
                </nav>`;

            // Re-apply dark mode to root if needed (safety check)
            if (state.darkMode) document.documentElement.classList.add('dark');
        };

        // COMPREHENSIVE AUTO-REFRESH PREVENTION

        // 1. Prevent all form submissions from refreshing the page
        // 1. Prevent all form submissions from refreshing the page
        document.addEventListener('submit', (e) => {
            console.log('Form submission prevented');
            e.preventDefault();
            // Do NOT stop propagation, otherwise specific form handlers like handleLogin won't run
            // e.stopPropagation(); 
            return false;
        }, true);

        // 2. Prevent all link clicks from navigating
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        // 3. Prevent any accidental page navigation
        window.addEventListener('beforeunload', (e) => {
            // Only prevent if user is logged in and has active data
            if (state.user && state.activeTrip) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // 4. Prevent browser back button from refreshing
        window.history.pushState(null, '', window.location.href);
        window.addEventListener('popstate', (e) => {
            window.history.pushState(null, '', window.location.href);
            e.preventDefault();
            return false;
        });

        // 5. Log any page load to debug
        console.log('Driver App loaded at:', new Date().toISOString());
        let renderCount = 0;
        const originalRender = window.render;
        let globalRenderTimeout = null;
        window.render = function () {
            if (globalRenderTimeout) clearTimeout(globalRenderTimeout);
            globalRenderTimeout = setTimeout(() => {
                renderCount++;
                console.log('Render called #' + renderCount + ' (Debounced)');
                originalRender.apply(this, arguments);
                globalRenderTimeout = null;
            }, 50);
        };

        initAuth();
    </script>
</body>

</html>
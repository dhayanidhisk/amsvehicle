<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>AMS Driver App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            surface: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --gradient-danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            --gradient-blue: linear-gradient(135deg, #2196F3 0%, #1976D2 50%, #673AB7 100%);
            --gradient-green: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.16);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(56, 239, 125, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif;
        }

        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .fade-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(56, 239, 125, 0.4);
            }

            50% {
                box-shadow: 0 0 40px rgba(56, 239, 125, 0.6);
            }
        }

        .gradient-text {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .btn-gradient {
            background: var(--gradient-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-gradient:hover::before {
            left: 100%;
        }

        .btn-gradient:active {
            transform: scale(0.98);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }

        .gradient-border {
            position: relative;
            background: white;
            border-radius: 1rem;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 1rem;
            padding: 2px;
            background: var(--gradient-primary);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            /* Ensure minimum font size for inputs to prevent zoom on iOS */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Optimize glassmorphism for mobile performance */
            .glass,
            .glass-strong {
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }

            /* Reduce animations on mobile for performance */
            .pulse-glow {
                animation: none;
                box-shadow: 0 0 20px rgba(56, 239, 125, 0.4);
            }

            /* Larger touch targets */
            button {
                min-height: 44px;
                min-width: 44px;
            }

            /* Optimize spacing for mobile */
            .p-6 {
                padding: 1rem !important;
            }

            .p-8 {
                padding: 1.5rem !important;
            }

            .p-10 {
                padding: 2rem !important;
            }

            .gap-6 {
                gap: 1rem !important;
            }

            /* Make modals more mobile-friendly */
            .max-w-md {
                max-width: calc(100vw - 2rem) !important;
            }

            /* Optimize header for mobile */
            header {
                padding: 1rem !important;
            }

            /* Better mobile navigation */
            nav {
                padding: 0.5rem !important;
            }
        }

        /* Disable hover effects on touch devices */
        @media (hover: none) {
            .hover-lift:hover {
                transform: none;
            }

            .btn-gradient:hover::before {
                left: -100%;
            }
        }

        /* Safe area support for notched phones */
        @supports (padding: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
            }
        }

        /* Prevent text selection on buttons for better mobile UX */
        button {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Smooth scrolling */
        * {
            -webkit-overflow-scrolling: touch;
        }

        /* Optimize for small screens */
        @media (max-width: 375px) {
            h1 {
                font-size: 1.25rem !important;
            }

            h2 {
                font-size: 1.125rem !important;
            }

            h3 {
                font-size: 1rem !important;
            }

            .text-4xl {
                font-size: 1.875rem !important;
            }

            .text-3xl {
                font-size: 1.5rem !important;
            }

            .text-2xl {
                font-size: 1.25rem !important;
            }

            .text-xl {
                font-size: 1.125rem !important;
            }
        }
    </style>
</head>

<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col relative pb-20" style="position: relative; z-index: 1;">
        <div id="loading-screen"
            class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-500"
            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="flex flex-col items-center gap-6 scale-in">
                <div class="relative">
                    <div class="absolute inset-0 animate-ping rounded-full bg-white opacity-20"></div>
                    <div class="relative w-20 h-20 rounded-full glass-dark flex items-center justify-center">
                        <i class="ph-fill ph-truck text-4xl text-white"></i>
                    </div>
                </div>
                <div class="text-center">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                    <p class="text-white text-base font-semibold">Connecting Driver App...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modals"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, setDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, Timestamp, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD1YRKvTHkK0QNMEdxfWbNCrKSWRzVOxdg",
            authDomain: "ams-service-f923f.firebaseapp.com",
            projectId: "ams-service-f923f",
            storageBucket: "ams-service-f923f.firebasestorage.app",
            messagingSenderId: "31368661696",
            appId: "1:31368661696:web:61b78217d78ed9cec8fb25",
            measurementId: "G-C0JVW9GMZJ"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ams-towing-v1';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Mocks removed - fetching dynamically
        const TOYOTA_MODELS = []; // Deprecated, using state.models
        const CATEGORIES = { NEW: ['TVS', 'INT', 'FREE'], BREAKDOWN: ['TVS', 'Service', 'Direct'], EMPTY: [] };

        window.state = {
            user: null,
            view: 'login',
            driverTab: 'home',
            activeTrip: null,
            locations: [],
            models: [],
            shiftStatus: 'offline',
            trips: [],
            monthlyAttendance: [],
            leaveRequests: [],
            isContinuedSession: false,
            lastTripData: null,
            form: { truck: '', date: new Date().toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' },
            form: { truck: '', date: new Date().toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' },
            policeFines: [],
            tollLogs: [],
            expensesMode: null,
            modal: null,
            darkMode: false
        };

        // Initialize Theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            window.state.darkMode = true;
        }

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            render();
        };

        const state = window.state;
        const appDiv = document.getElementById('app');
        const modalDiv = document.getElementById('modals');
        const loadingScreen = document.getElementById('loading-screen');

        const formatTime = (ts) => { if (!ts) return '--:--'; const date = ts.toDate ? ts.toDate() : new Date(ts); return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); };
        const formatDate = (ts) => { if (!ts) return '--/--'; const date = ts.toDate ? ts.toDate() : new Date(ts); return date.toLocaleDateString(); };

        const initAuth = async () => {
            try {
                let signedIn = false;
                // 1. Try Custom Token if available
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        signedIn = true;
                    } catch (e) {
                        console.warn("Custom token mismatch, falling back to anonymous auth");
                    }
                }

                // 2. Fallback to Anonymous
                if (!signedIn) {
                    await signInAnonymously(auth);
                }

                // Real-time listener for Vehicles is moved to global scope or separate init to ensure it runs
                const vQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'), where('status', 'in', ['Active', 'active']));
                onSnapshot(vQ, (s) => {
                    state.vehicles = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });

                const lQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_locations'), where('status', 'in', ['Active', 'active']));
                onSnapshot(lQ, (s) => {
                    state.locations = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });

                const mQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicle_models'), where('status', 'in', ['Active', 'active']));
                onSnapshot(mQ, (s) => {
                    state.models = s.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                });

            } catch (error) {
                console.error("Auth Failed", error);
                loadingScreen.innerHTML = `<div class="text-white text-center p-4"><p class="font-bold mb-2">Connection Error</p><p class="text-xs text-slate-300">${error.code || error.message}</p></div>`;
            }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
                if (!state.user) render();
            }
        });

        let unsubscribers = [];

        const setupListeners = () => {
            if (!state.user) return;

            // Listen for latest status
            const statusQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(statusQ, (s) => {
                const docs = s.docs.map(d => d.data());
                docs.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                if (docs.length > 0) {
                    state.shiftStatus = docs[0].status;
                } else {
                    state.shiftStatus = 'offline';
                }
                render();
            }));

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(q, (s) => {
                const allTrips = s.docs.map(d => ({ id: d.id, ...d.data() }));
                allTrips.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.trips = allTrips;
                state.activeTrip = allTrips.find(t => t.status === 'active') || null;

                // Auto-correct: If active trip found but user is offline, switch to online automatically
                if (state.activeTrip && state.shiftStatus === 'offline') {
                    console.log("Auto-correcting status to ONLINE due to active trip");
                    window.toggleShift();
                }

                if (state.activeTrip && (state.modal === 'startTrip' || state.modal === 'postTrip')) state.modal = null;
                render();
            }));

            // Global listener for ALL active trips (for vehicle locking across all drivers)
            const activeTripsQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'), where('status', '==', 'active'));
            unsubscribers.push(onSnapshot(activeTripsQ, (s) => {
                state.allActiveTrips = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));


            const attQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(attQ, (s) => { state.monthlyAttendance = s.docs.map(d => d.data()); render(); }));

            const leaveQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(leaveQ, (s) => { state.leaveRequests = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); render(); }));

            // Load all active vehicles for dropdown (filtered by client-side or query if needed)
            const vQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles'), where('status', '==', 'Active'));
            unsubscribers.push(onSnapshot(vQ, (s) => {
                state.vehicles = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            }));
            // Fetch Expenses for History
            const pfQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_police_fines'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(pfQ, (s) => { state.policeFines = s.docs.map(d => ({ id: d.id, ...d.data(), dataType: 'fine' })); render(); }));

            const tlQ = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_toll_logs'), where('driverName', '==', state.user.name));
            unsubscribers.push(onSnapshot(tlQ, (s) => { state.tollLogs = s.docs.map(d => ({ id: d.id, ...d.data(), dataType: 'toll' })); render(); }));
        };

        window.handleLogin = async (e) => {
            e.preventDefault();
            if (!auth.currentUser) await initAuth();
            const phone = document.getElementById('login-phone').value.trim();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Verifying...';
            btn.disabled = true;

            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_drivers'), where('phone', '==', phone), where('status', '==', 'Active'));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const docData = snapshot.docs[0].data();
                    state.user = { name: docData.name, role: 'driver', phone: docData.phone, id: snapshot.docs[0].id, branch: docData.branch || 'Coimbatore' };
                    state.view = 'driver';
                    setupListeners();
                } else {
                    alert('Phone number not found or inactive. Please contact Admin.');
                }
            } catch (err) {
                console.error(err);
                alert('Login failed: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                render();
            }
            return false;
        };

        window.handleLogout = () => {
            state.user = null; state.view = 'login'; state.activeTrip = null; state.trips = [];
            unsubscribers.forEach(u => u()); unsubscribers = [];
            render();
        };

        window.toggleShift = async () => {
            if (state.shiftStatus === 'online' && state.activeTrip) {
                return alert("⚠️ You cannot go Off Duty while a trip is active. Please end your trip first.");
            }

            const today = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'ams_attendance'), where('driverName', '==', state.user.name));
            const snapshot = await getDocs(q);
            const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            docs.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
            const latestDoc = docs.length > 0 ? docs[0] : null;

            let newStatus;
            if (state.activeTrip) {
                newStatus = 'online';
            } else {
                newStatus = state.shiftStatus === 'online' ? 'offline' : 'online';
            }

            try {
                if (newStatus === 'offline' && latestDoc && latestDoc.status === 'online') {
                    // Update the record that is currently online
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_attendance', latestDoc.id), {
                        status: 'offline',
                        checkOutTime: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                } else if (newStatus === 'online') {
                    // Start new online session
                    const docId = `${today}_${state.user.name}`;
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_attendance', docId), {
                        driverId: state.user.phone, driverName: state.user.name, driverPhone: state.user.phone,
                        date: today, status: 'online', checkInTime: serverTimestamp(), lastUpdated: serverTimestamp()
                    }, { merge: true });
                }
                state.shiftStatus = newStatus;
                render();
            } catch (e) {
                console.error("Error toggling shift:", e);
                alert("Connection error. Please try again.");
            }
        };

        const getVehicleOdo = (truckNo) => {
            const v = state.vehicles.find(v => (v.vehicleNumber || v.number) === truckNo);
            return v ? (v.odometer || '') : '';
        };

        window.openStartTripModal = (e) => {
            e.preventDefault();
            const f = state.form;
            if (!f.truck || !f.date || (!f.pickup && !f.pickupOther) || (!f.drop && !f.dropOther)) return alert("Please fill Truck, Date, Pickup and Drop.");

            // Skip Terms & Conditions for Empty trips
            if (f.cat === 'Empty') {
                state.termsData = {
                    beltCondition: true, // Assume checked/NA
                    deliveryChallan: 'NA',
                    invoiceCopy: 'NA',
                    eWayBill: 'NA',
                    lorryReceipt: 'NA'
                };
                state.modal = 'startTrip';
                render();
                return false;
            }

            // Initialize terms data
            state.termsData = {
                beltCondition: false,
                deliveryChallan: '',
                invoiceCopy: '',
                eWayBill: '',
                lorryReceipt: ''
            };
            state.modal = 'termsConditions';
            render();
            return false;
        };

        window.acceptTerms = () => {
            const td = state.termsData;
            // Validate all fields are filled
            if (!td.beltCondition) return alert("Please confirm Belt Condition");
            if (!td.deliveryChallan || !td.invoiceCopy || !td.eWayBill || !td.lorryReceipt) {
                return alert("Please fill all document fields (Yes/No/NA)");
            }
            state.modal = 'startTrip';
            render();
        };

        window.updateTerms = (field, val) => {
            state.termsData[field] = val;
            render();
        };

        window.confirmStartTrip = async () => {
            const odo = document.getElementById('start-odo').value;
            if (!odo) return;
            if (parseFloat(odo) <= 0) return alert("Please enter a valid positive odometer reading.");
            if (odo.length !== 6) return alert("Odometer reading must be exactly 6 digits.");

            // Validate against previous reading (auto-filled value)
            const minOdo = state.isContinuedSession ? (state.lastTripData?.endOdo || 0) : getVehicleOdo(state.form.truck);
            if (parseFloat(odo) < parseFloat(minOdo)) {
                return alert(`Start Odometer cannot be less than previous reading (${minOdo}).`);
            }

            const f = state.form;
            const pickup = f.pickup === 'Other' ? f.pickupOther : f.pickup;
            const drop = f.drop === 'Other' ? f.dropOther : f.drop;
            const model = f.model === 'Other' ? f.modelOther : f.model;
            try {
                // Auto-start shift if offline
                if (state.shiftStatus === 'offline') {
                    await window.toggleShift();
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_trips'), {
                    driverName: state.user.name, truckNumber: f.truck, date: f.date, pickupLocation: pickup, dropLocation: drop,
                    tripCategory: f.cat, tripType: f.cat === 'Empty' ? 'Empty' : f.type, customerName: f.customer || null, referrer: f.referrer || null,
                    vehicleModel: f.cat === 'Empty' ? null : model, vehicleNumber: f.cat === 'Empty' ? null : f.vehicleNo,
                    startOdo: odo, status: 'active', startTime: serverTimestamp(), createdAt: serverTimestamp(),
                    // Terms and Conditions data
                    termsAccepted: true,
                    beltCondition: state.termsData.beltCondition,
                    deliveryChallan: state.termsData.deliveryChallan,
                    invoiceCopy: state.termsData.invoiceCopy,
                    eWayBill: state.termsData.eWayBill,
                    lorryReceipt: state.termsData.lorryReceipt
                });
                state.modal = null; render();
            } catch (error) {
                console.error("Error starting trip:", error);
                alert("Failed to start trip. Please check your connection and try again.\nError: " + error.message);
            }
        };

        window.confirmStopTrip = async () => {
            const odo = document.getElementById('end-odo').value;
            if (!odo) return;
            if (odo.length !== 6) return alert("Odometer reading must be exactly 6 digits.");
            if (state.activeTrip && parseFloat(odo) <= parseFloat(state.activeTrip.startOdo)) {
                return alert(`End Odometer (${odo}) must be greater than Start Odometer (${state.activeTrip.startOdo})`);
            }
            if (!state.activeTrip) {
                return alert("Error: Active trip data missing. Please refresh the page and try again.");
            }
            // Capture values BEFORE async call, because onSnapshot might clear state.activeTrip when status changes to 'completed'
            const currentDrop = state.activeTrip.dropLocation;
            const currentPickup = state.activeTrip.pickupLocation;
            const currentTruckRaw = state.activeTrip.truckNumber;
            const tripId = state.activeTrip.id;

            try {
                // Update Trip Status
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), { endTime: serverTimestamp(), endOdo: odo, status: 'completed' });

                // Update Vehicle Odometer
                // Find vehicle ID
                const vehicle = state.vehicles.find(v => (v.vehicleNumber || v.number) === currentTruckRaw);
                if (vehicle) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_vehicles', vehicle.id), { odometer: odo });
                }

                // Snap truck number to vehicle list definition to ensure dropdown match
                const currentTruck = vehicle ? (vehicle.vehicleNumber || vehicle.number) : currentTruckRaw;

                state.lastTripData = { dropLocation: currentDrop, pickupLocation: currentPickup, truckNumber: currentTruck, endOdo: odo };
                state.modal = 'postTrip';
                render();
            } catch (error) {
                console.error("Error stopping trip:", error);
                alert("Failed to stop trip. Please check your connection and try again.\nError: " + error.message);
            }
        };

        // --- Driver Trip Editing ---
        window.openEditTripModal = (tripId) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.editTrip = { ...trip };
            state.modal = 'editTrip';
            render();
        };

        window.saveTripEdit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripData = Object.fromEntries(formData.entries());
            const tripId = state.editTrip.id;

            if (parseInt(tripData.endOdo) <= parseInt(tripData.startOdo)) {
                return alert('End Odometer must be greater than Start Odometer');
            }

            try {
                // Save as pending changes instead of direct update
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'ams_trips', tripId), {
                    pendingChanges: {
                        ...tripData,
                        requestedAt: serverTimestamp(),
                        requestedBy: state.user.name
                    },
                    hasPendingChanges: true,
                    updatedAt: serverTimestamp()
                });
                state.modal = null;
                render();
                alert("Edit requested successfully! Wating for Admin approval.");
            } catch (error) {
                console.error("Error updating trip:", error);
                alert("Failed to request update: " + error.message);
            }
        };

        window.openTripOptions = (tripId, veh, sOdo, eOdo, date, isLatest) => {
            const trip = state.trips.find(t => t.id === tripId);
            if (!trip) return;
            state.lastTripData = { dropLocation: trip.dropLocation, pickupLocation: trip.pickupLocation, truckNumber: trip.truckNumber, endOdo: trip.endOdo };
            state.viewTrip = trip; // Store for View Details
            state.isContinuedSession = true; // Set to true to allow return trip logic to work
            state.isLatestTrip = isLatest; // Flag for first card options
            state.modal = 'postTrip';
            render();
        };

        window.handleReturnTrip = () => {
            state.isContinuedSession = true; state.modal = null;
            const lastDrop = state.lastTripData?.dropLocation || '';
            const lastPickup = state.lastTripData?.pickupLocation || '';

            const locationNames = state.locations ? state.locations.map(l => l.name) : [];
            const isStdDrop = locationNames.includes(lastDrop);
            const isStdPickup = locationNames.includes(lastPickup);

            // Swap locations: New Pickup = Old Drop, New Drop = Old Pickup
            state.form.pickup = isStdDrop ? lastDrop : 'Other';
            state.form.pickupOther = isStdDrop ? '' : lastDrop;

            state.form.drop = isStdPickup ? lastPickup : 'Other';
            state.form.dropOther = isStdPickup ? '' : lastPickup;

            state.form.cat = 'New'; state.form.type = 'TVS';
            state.form.truck = state.lastTripData?.truckNumber || '';
            state.form.model = ''; state.form.vehicleNo = ''; state.form.customer = '';
            render();
        };

        window.handleContinueSession = () => {
            state.isContinuedSession = true; state.modal = null;
            const lastDrop = state.lastTripData?.dropLocation || '';
            const locationNames = state.locations ? state.locations.map(l => l.name) : [];
            const isStdLoc = locationNames.includes(lastDrop);
            state.form.pickup = isStdLoc ? lastDrop : 'Other'; state.form.pickupOther = isStdLoc ? '' : lastDrop;
            state.form.truck = state.lastTripData?.truckNumber || '';
            state.form.drop = ''; state.form.dropOther = ''; state.form.cat = 'New'; state.form.type = 'TVS';
            state.form.model = ''; state.form.vehicleNo = ''; state.form.customer = '';
            render();
        };

        window.handleEndDuty = () => {
            state.isContinuedSession = false; state.lastTripData = null; state.modal = null;
            state.form = { truck: '', date: new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0], cat: 'New', type: 'TVS', pickup: '', drop: '', pickupOther: '', dropOther: '', model: '', modelOther: '', vehicleNo: '', customer: '' };
            render();
        };

        window.openFineDetails = (fineId) => {
            const fines = Array.isArray(state.policeFines) ? state.policeFines : [];
            const fine = fines.find(f => f.id === fineId);
            if (!fine) {
                alert('Fine details not found.');
                return;
            }
            state.viewFine = fine;
            state.modal = 'fineDetails';
            render();
        };

        window.submitLeave = async (e) => {
            e.preventDefault();
            const start = document.getElementById('leave-start').value;
            const end = document.getElementById('leave-end').value;
            const reason = document.getElementById('leave-reason').value;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_leave_requests'), {
                driverName: state.user.name, driverPhone: state.user.phone, startDate: start, endDate: end, reason: reason, status: 'pending', createdAt: serverTimestamp()
            });
            state.modal = null; render();
            return false;
        };

        // Debounce render to avoid UI flicker on rapid updates
        let renderTimeout = null;
        const scheduleRender = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                render();
                renderTimeout = null;
            }, 150);
        };

        // Updated updateForm to use scheduleRender for fields that need UI update
        window.updateForm = (field, val) => {
            state.form[field] = val;
            const fieldsRequiringRender = ['truck', 'date', 'pickup', 'drop', 'cat', 'type', 'model'];
            if (fieldsRequiringRender.includes(field)) {
                scheduleRender();
            }
        };

        const renderLogin = () => `
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="glass-strong rounded-3xl shadow-2xl p-10 w-full max-w-md text-center hover-lift" style="box-shadow: var(--shadow-xl);">
                    <div class="relative mb-8">
                        <div class="absolute inset-0 blur-2xl opacity-30" style="background: var(--gradient-primary);"></div>
                        <div class="relative w-24 h-24 rounded-3xl flex items-center justify-center mx-auto shadow-2xl" style="background: var(--gradient-blue);">
                            <i class="ph-fill ph-steering-wheel text-5xl text-white"></i>
                        </div>
                    </div>
                    <h1 class="text-4xl font-bold mb-2" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Driver Login</h1>
                    <p class="text-slate-600 mb-8 text-lg font-medium">AMS Towing Service</p>
                    <form onsubmit="return handleLogin(event)" class="space-y-6">
                        <div class="relative group">
                            <i class="ph ph-phone absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl transition-colors group-focus-within:text-purple-600"></i>
                            <input type="tel" id="login-phone" class="w-full pl-12 pr-4 py-4 bg-white border-2 border-slate-200 rounded-2xl text-lg transition-all" placeholder="Enter Phone Number" required pattern="[0-9]{10}" maxlength="10" style="box-shadow: var(--shadow-sm);">
                        </div>
                        <button type="submit" class="w-full py-5 text-white rounded-2xl font-bold text-lg shadow-xl relative overflow-hidden btn-gradient">
                            <span class="relative z-10 flex items-center justify-center gap-2">
                                <i class="ph-bold ph-sign-in"></i>
                                Start Shift
                            </span>
                        </button>
                    </form>
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <p class="text-xs text-slate-400 font-medium">Authorized Personnel Only</p>
                    </div>
                </div>
            </div>`;

        const renderHome = () => {
            // Filter trips/expenses from the last 36 hours
            const now = new Date();
            const timeLimit = new Date(now.getTime() - (36 * 60 * 60 * 1000));

            // Merge all history items
            const trips = state.trips.filter(t => t.status === 'completed').map(t => ({ ...t, dataType: 'trip' }));
            const fines = (state.policeFines || []).map(f => ({ ...f, dataType: 'fine' }));
            const tolls = (state.tollLogs || []).map(t => ({ ...t, dataType: 'toll' }));

            let allHistory = [...trips, ...fines, ...tolls].filter(item => {
                const t = item.timestamp ? new Date(item.timestamp.seconds * 1000) : new Date(item.createdAt?.seconds * 1000 || 0);
                return t >= timeLimit;
            });

            // Sort by time descending
            allHistory.sort((a, b) => {
                const ta = a.timestamp ? a.timestamp.seconds : (a.createdAt?.seconds || 0);
                const tb = b.timestamp ? b.timestamp.seconds : (b.createdAt?.seconds || 0);
                return tb - ta;
            });

            // Identify trips with fines
            // Create a map for easy lookup: tripId -> fineObject
            const fineMap = {};
            fines.forEach(f => { if (f.tripId) fineMap[f.tripId] = f; });

            // Filter history to show ONLY trips (as requested)
            const recentHistory = allHistory.filter(item => item.dataType === 'trip');

            return `
                <div style="display: flex; flex-direction: column; gap: 24px; padding-bottom: 128px;">
                    <!-- DUTY STATUS CARD -->
                    <div class="relative rounded-2xl overflow-hidden ${state.shiftStatus === 'online' ? 'pulse-glow' : ''}" style="box-shadow: var(--shadow-lg);">
                        <div class="glass-strong p-6 relative">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Duty Status</p>
                                    <div class="flex items-center gap-3">
                                        ${state.shiftStatus === 'online' ? `
                                        <span class="relative flex h-4 w-4">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-4 w-4 bg-green-500"></span>
                                        </span>
                                        <span class="text-2xl font-bold" style="background: var(--gradient-green); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ON DUTY</span>
                                    ` : `
                                        <div class="h-4 w-4 rounded-full bg-slate-400"></div>
                                        <span class="text-2xl font-bold text-slate-500">OFF DUTY</span>
                                    `}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" onclick="toggleShift()" ${state.activeTrip ? 'disabled' : ''} class="w-full py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${state.shiftStatus === 'online' ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white shadow-lg' : 'btn-gradient text-white shadow-lg'} ${state.activeTrip ? 'opacity-50 cursor-not-allowed' : 'hover-lift'}" style="${!state.activeTrip ? 'box-shadow: var(--shadow-md);' : ''}">
                            <i class="ph-bold ph-power text-lg"></i>
                            ${state.shiftStatus === 'online' ? 'End Shift' : 'Start Shift'}
                        </button>
                    </div>
                    ${state.shiftStatus === 'online' ? '<div class="absolute top-0 left-0 right-0 h-1" style="background: var(--gradient-green);"></div>' : ''}

                ${state.activeTrip ? renderActiveTrip() : renderNewTripForm()}
                
                <!-- HISTORY CARD WITH ACTIONS -->
            <div class="glass-strong rounded-3xl p-8 dark:bg-slate-800 dark:border dark:border-slate-700 transition-colors" style="box-shadow: var(--shadow-xl);">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2">
                        <span class="p-2 rounded-lg bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400"><i class="ph-bold ph-clock-counter-clockwise"></i></span>
                        Today's History
                    </h3>
                    <span class="text-xs font-bold px-2.5 py-1 rounded-full bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-400">${recentHistory.length} Items</span>
                </div>

                <div class="space-y-5">
                    ${recentHistory.length === 0 ? '<div class="text-center py-8"><i class="ph-fill ph-package text-4xl text-slate-300 dark:text-slate-600 mb-4 block"></i><p class="text-slate-400 dark:text-slate-500 italic text-sm">No recent activity</p></div>' : ''}
                    ${recentHistory.map((item, index) => {
                if (item.dataType === 'trip') {
                    const linkedFine = fineMap[item.id];
                    return `
                                <div class="glass p-4 rounded-xl hover-lift dark:bg-slate-700 dark:border-slate-600 transition-colors" style="box-shadow: var(--shadow-sm);">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="font-bold text-slate-800 dark:text-slate-100 mb-1">${item.vehicleModel || 'Empty'} 
                                                <span class="text-slate-400 dark:text-slate-400 font-normal text-xs ml-1">${item.vehicleNumber || ''}</span>
                                            </div>
                                            <div class="text-xs text-slate-500 dark:text-slate-300 flex items-center gap-1">
                                                <i class="ph-fill ph-map-pin text-purple-600 dark:text-purple-400"></i> 
                                                ${item.pickupLocation} <i class="ph-bold ph-arrow-right text-[10px]"></i> ${item.dropLocation}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            ${linkedFine ? `<button onclick="openFineDetails('${linkedFine.id}')" class="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200 transition-colors"><i class="ph-fill ph-siren text-lg animate-pulse"></i></button>` : ''}
                                            <button onclick="openTripOptions('${item.id}', '${item.vehicleNumber || ''}', '${item.startOdo || ''}', '${item.endOdo || ''}', '${item.date || ''}', ${index === 0})" class="px-3 py-1.5 bg-purple-50 text-purple-600 rounded-lg text-xs font-bold hover:bg-purple-100 transition-colors flex items-center gap-1">More <i class="ph-bold ph-caret-down"></i></button>
                                            ${item.hasPendingChanges ? `
                                            <button disabled class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold cursor-not-allowed opacity-70"><i class="ph-bold ph-clock-counter-clockwise"></i> Pending</button>
                                            ` : `
                                            <button onclick="openEditTripModal('${item.id}')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors"><i class="ph-bold ph-pencil-simple"></i> Edit</button>
                                            `}
                                        </div>
                                    </div>
                                </div>`;
                } else if (item.dataType === 'fine') {
                    return `
                                <div class="glass p-4 rounded-xl hover-lift dark:bg-slate-700 dark:border-slate-600 transition-colors border-l-4 border-l-red-400" style="box-shadow: var(--shadow-sm);">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="font-bold text-red-600 mb-1 flex items-center gap-2"><i class="ph-fill ph-siren"></i> Police Fine</div>
                                            <div class="text-xs text-slate-500 dark:text-slate-300">
                                                ₹${item.amount} ${item.pickup ? `• ${item.pickup} -> ${item.drop}` : ''}
                                            </div>
                                        </div>
                                        <span class="text-[10px] text-slate-400">${formatTime(item.timestamp)}</span>
                                    </div>
                                </div>`;
                } else if (item.dataType === 'toll') {
                    return `
                                <div class="glass p-4 rounded-xl hover-lift dark:bg-slate-700 dark:border-slate-600 transition-colors border-l-4 border-l-blue-400" style="box-shadow: var(--shadow-sm);">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="font-bold text-blue-600 mb-1 flex items-center gap-2"><i class="ph-fill ph-road-horizon"></i> Toll Gate</div>
                                            <div class="text-xs text-slate-500 dark:text-slate-300">
                                                ₹${item.amount} ${item.pickup ? `• ${item.pickup} -> ${item.drop}` : ''}
                                            </div>
                                        </div>
                                        <span class="text-[10px] text-slate-400">${formatTime(item.timestamp)}</span>
                                    </div>
                                </div>`;
                }
            }).join('')}
                </div>
            </div>
            </div>
            </div>`;
        };

        const renderActiveTrip = () => `
            <div class="glass-strong rounded-2xl overflow-hidden" style="box-shadow: var(--shadow-xl);">
                <div class="relative p-5 text-white overflow-hidden" style="background: var(--gradient-success);">
                    <div class="absolute inset-0 opacity-20" style="background: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;0.4&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                    <div class="relative flex justify-between items-center">
                        <h2 class="font-bold text-xl flex items-center gap-2">
                            <i class="ph-fill ph-navigation-arrow text-2xl"></i> 
                            Trip in Progress
                        </h2>
                        <div class="glass-dark px-3 py-1.5 rounded-lg">
                            <span class="text-sm font-mono font-semibold">${formatTime(state.activeTrip.startTime)}</span>
                        </div>
                    </div>
                </div>
                <div class="p-6 space-y-5">
                    <div>
                        <h3 class="text-2xl font-bold mb-1" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ${state.activeTrip.vehicleModel || 'Empty Run'}
                        </h3>
                        <p class="text-slate-500 font-medium">${state.activeTrip.vehicleNumber || 'No vehicle number'}</p>
                    </div>
                    <div class="glass p-5 rounded-xl" style="box-shadow: var(--shadow-sm);">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1.5">Pickup Location</p>
                                <p class="font-semibold text-slate-800 text-sm">${state.activeTrip.pickupLocation}</p>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center" style="background: var(--gradient-primary);">
                                    <i class="ph-bold ph-arrow-right text-white text-lg"></i>
                                </div>
                            </div>
                            <div class="flex-1 text-right">
                                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1.5">Drop Location</p>
                                <p class="font-semibold text-slate-800 text-sm">${state.activeTrip.dropLocation}</p>
                            </div>
                        </div>
                    </div>
                    <button type="button" onclick="state.modal='stopTrip'; render()" class="w-full py-4 text-white rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-xl relative overflow-hidden transition-all hover-lift" style="background: var(--gradient-danger);">
                        <i class="ph-bold ph-stop-circle text-2xl"></i> 
                        Stop Trip
                    </button>
                </div>
            </div>`;

        const renderNewTripForm = () => {
            if (state.shiftStatus === 'offline') return `
            <div class="glass-strong rounded-2xl p-10 text-center border-2 border-dashed border-slate-300 dark:border-slate-700 transition-colors relative overflow-hidden group">
                <div class="absolute inset-0 opacity-0 group-hover:opacity-10 transition-opacity bg-gradient-to-br from-slate-400 to-slate-100 dark:from-slate-700 dark:to-slate-800"></div>
                <div class="relative z-10">
                    <div class="w-20 h-20 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mx-auto mb-6 shadow-sm group-hover:scale-110 transition-transform duration-500">
                        <i class="ph-fill ph-coffee text-4xl text-slate-400 dark:text-slate-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-700 dark:text-slate-200 mb-2">You are Off Duty</h3>
                    <p class="text-slate-500 dark:text-slate-400 font-medium max-w-xs mx-auto">Your shift hasn't started yet. Go <span class="text-slate-800 dark:text-white font-bold">ON DUTY</span> above to begin your day.</p>
                </div>
            </div>`;
            const f = state.form;

            // Get all vehicles for the user's branch
            const userBranch = state.user.branch || 'Coimbatore';
            const branchVehicles = state.vehicles ? state.vehicles.filter(v => (v.branch || 'Coimbatore') === userBranch) : [];

            // Get all active trips for determining lock status
            const activeTrips = state.allActiveTrips || [];
            const lockedMap = new Map();
            activeTrips.forEach(t => {
                if (t.truckNumber && t.status === 'active') {
                    lockedMap.set(t.truckNumber, t.driverName || 'In Use');
                }
            });

            // Categorize branch vehicles into available or locked
            const availableOptionsArr = [];
            const lockedOptionsArr = [];

            branchVehicles.forEach(v => {
                const vNum = v.vehicleNumber || v.number;
                const driverOnTrip = lockedMap.get(vNum);

                if (driverOnTrip) {
                    lockedOptionsArr.push(`<option value="${vNum}" disabled>🔒 ${vNum} (${driverOnTrip} - On Trip)</option>`);
                } else {
                    availableOptionsArr.push(`<option value="${vNum}" ${f.truck === vNum ? 'selected' : ''}>${vNum}</option>`);
                }
            });

            const availableOptions = availableOptionsArr.join('');
            const lockedOptions = lockedOptionsArr.join('');

            const vehicleOptions = availableOptions || lockedOptions ?
                availableOptions + lockedOptions :
                '<option disabled>Loading...</option>';



            const ub = state.user.branch || 'Coimbatore';
            const branchLocations = state.locations ? state.locations.filter(l => {
                // Multi-branch support
                if (l.branches && Array.isArray(l.branches)) {
                    return l.branches.includes('All') || l.branches.includes(ub);
                }
                // Legacy support
                const lb = l.branch || 'All';
                return lb === 'All' || lb === ub;
            }).sort((a, b) => a.name.localeCompare(b.name)) : [];
            const locationOptions = (selected) => branchLocations.map(l => `<option value="${l.name}" ${selected === l.name ? 'selected' : ''}>${l.name}</option>`).join('');

            return `<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-8 transition-colors"><h2 class="text-xl font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2"><i class="ph-fill ph-play-circle text-blue-600 dark:text-blue-400 text-2xl"></i> ${state.isContinuedSession ? 'Continue Duty' : 'Start New Trip'}</h2><form onsubmit="return openStartTripModal(event)" class="space-y-6"><div class="grid grid-cols-2 gap-5"><select onchange="updateForm('truck', this.value)" class="w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-xl outline-none" required ${state.isContinuedSession && f.truck ? 'disabled' : ''}><option value="">Select Truck</option>${vehicleOptions}</select>
            ${state.isContinuedSession ?
                    `<input type="text" value="${f.date.split('-').reverse().join('-')}" class="w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-xl outline-none" disabled>` :
                    `<input type="date" value="${f.date}" oninput="updateForm('date', this.value)" class="w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-xl outline-none" required>`
                }
            </div><div class="p-6 bg-slate-50 dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 space-y-4">${state.isContinuedSession ? '<div class="text-xs text-blue-600 dark:text-blue-400"><i class="ph-bold ph-check"></i> Pickup auto-filled</div>' : ''}<div><select onchange="updateForm('pickup', this.value)" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required><option value="">Pickup</option>${locationOptions(f.pickup)}<option value="Other" ${f.pickup === 'Other' ? 'selected' : ''}>Other...</option></select>${f.pickup === 'Other' ? `<input type="text" value="${f.pickupOther}" oninput="updateForm('pickupOther', this.value)" placeholder="Enter Pickup" class="w-full mt-3 p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required>` : ''}</div><div><select onchange="updateForm('drop', this.value)" class="w-full p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required><option value="">Drop</option>${locationOptions(f.drop)}<option value="Other" ${f.drop === 'Other' ? 'selected' : ''}>Other...</option></select>${f.drop === 'Other' ? `<input type="text" value="${f.dropOther}" oninput="updateForm('dropOther', this.value)" placeholder="Enter Drop" class="w-full mt-3 p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required>` : ''}</div></div><div><label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-3 block">Category</label><div class="grid grid-cols-3 gap-3">${Object.keys(CATEGORIES).map(k => `<button type="button" onclick="updateForm('cat', '${CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break Down')}'); updateForm('type', '${CATEGORIES[k][0] || ''}')" class="py-3 rounded-xl text-sm font-bold border transition-all ${f.cat === (CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break Down')) ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 shadow-sm' : 'border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400'}">${CATEGORIES[k].length === 0 ? 'Empty' : (k === 'NEW' ? 'New' : 'Break')}</button>`).join('')}</div></div>                ${f.cat !== 'Empty' ? `
                    <div class="space-y-6">
                        <div class="flex flex-wrap gap-3">
                            ${(f.cat === 'New' ? CATEGORIES.NEW : CATEGORIES.BREAKDOWN).map(t => `<button type="button" onclick="updateForm('type', '${t}')" class="px-4 py-2 rounded-full text-xs font-bold border dark:border-slate-600 ${f.type === t ? 'bg-slate-800 dark:bg-slate-200 text-white dark:text-slate-900' : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}">${t}</button>`).join('')}
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <select onchange="updateForm('model', this.value)" class="w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required>
                                    <option value="">Model</option>${(state.models && state.models.length ? state.models.map(m => m.name) : TOYOTA_MODELS).map(m => `<option value="${m}" ${f.model === m ? 'selected' : ''}>${m}</option>`).join('')}<option value="Other" ${f.model === 'Other' ? 'selected' : ''}>Other...</option>
                                </select>
                                ${f.model === 'Other' ? `<input type="text" value="${f.modelOther}" oninput="updateForm('modelOther', this.value)" placeholder="Name" class="w-full mt-3 p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 dark:text-white rounded-xl text-sm" required>` : ''}
                            </div>
                            <input type="text" value="${f.vehicleNo}" oninput="updateForm('vehicleNo', this.value.toUpperCase())" placeholder="ABC-1234" class="w-full p-4 bg-slate-50 dark:bg-slate-900 border dark:border-slate-700 dark:text-white rounded-xl uppercase text-sm" required>
                        </div>
                        ${(f.cat === 'New' || (f.cat === 'Break Down' && (f.type === 'Service' || f.type === 'Direct' || f.type === 'TVS'))) ? (() => {
                        const isRequired = f.cat === 'Break Down' && (f.type === 'Service' || f.type === 'Direct');
                        return `
                        <div class="grid grid-cols-2 gap-5">
                            <input type="text" value="${f.customer}" oninput="updateForm('customer', this.value)" placeholder="Customer Name ${isRequired ? '' : '(Optional)'}" class="w-full p-4 bg-white dark:bg-slate-800 border ${isRequired ? 'border-amber-300 dark:border-amber-700' : 'dark:border-slate-700'} rounded-xl outline-none dark:text-white" ${isRequired ? 'required' : ''}>
                            <input type="text" value="${f.referrer || ''}" oninput="updateForm('referrer', this.value)" placeholder="Referred By ${isRequired ? '' : '(Optional)'}" class="w-full p-4 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl outline-none dark:text-white" ${isRequired ? 'required' : ''}>
                        </div>`;
                    })() : ''}
                    </div>` : ''}
                    <button type="submit" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all mt-4">Next <i class="ph-bold ph-arrow-right"></i></button>
                </form>
            </div>`;
        };


        const renderCalendar = (records, trips) => {
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const attMap = {}; records.forEach(r => attMap[r.date] = r.status);
            const tripCountMap = {}; trips.forEach(t => { if (t.status === 'completed' && t.date.startsWith(now.toISOString().slice(0, 7))) tripCountMap[t.date] = (tripCountMap[t.date] || 0) + 1; });
            let cal = '<div class="grid grid-cols-7 gap-1 mt-4">';
            for (let i = 1; i <= daysInMonth; i++) {
                const d = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                cal += `<div class="aspect-square flex flex-col items-center justify-center rounded-lg text-xs ${attMap[d] === 'online' ? 'bg-green-100 text-green-700 font-bold border border-green-200' : 'bg-slate-100 text-slate-400'} relative">${i}${tripCountMap[d] > 0 ? `<span class="absolute top-0 right-0 h-4 w-4 bg-blue-600 text-white text-[9px] flex items-center justify-center rounded-full -mt-1 -mr-1 shadow-sm font-bold">${tripCountMap[d]}</span>` : ''}</div>`;
            }
            return cal + '</div>';
        };

        window.renderFuel = () => {
            const userBranch = state.user?.branch || 'All';
            const vehicles = (state.vehicles || []).filter(v => v.branch === userBranch);

            return `
            <div class="animate-fade-in pb-24">
                 <div class="glass-strong rounded-2xl overflow-hidden mb-6" style="box-shadow: var(--shadow-lg);">
                    <div class="p-6 relative overflow-hidden" style="background: var(--gradient-warning);">
                        <div class="absolute right-0 top-0 p-4 opacity-20"><i class="ph-fill ph-gas-pump text-6xl text-white"></i></div>
                        <h2 class="text-2xl font-bold text-white mb-1">Fuel Log</h2>
                        <p class="text-amber-100 text-sm">Record fuel entries for ${userBranch}</p>
                    </div>
                </div>

                <form onsubmit="return submitFuel(event)" class="space-y-6">
                    <div class="glass p-6 rounded-2xl" style="box-shadow: var(--shadow-sm);">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Date</label>
                        <div class="relative">
                            <i class="ph-bold ph-calendar-blank absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                            <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full pl-12 p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all">
                        </div>
                    </div>

                    <div class="glass p-6 rounded-2xl" style="box-shadow: var(--shadow-sm);">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Select Vehicle</label>
                        <div class="relative">
                            <select name="vehicleNumber" required class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 appearance-none focus:outline-none focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all">
                                <option value="">Choose Vehicle...</option>
                                ${vehicles.map(v => `<option value="${v.vehicleNumber || v.number}">${v.vehicleNumber || v.number} (${v.make || 'Truck'})</option>`).join('')}
                            </select>
                            <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-2xl space-y-5" style="box-shadow: var(--shadow-sm);">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Fuel Amount (Litres)</label>
                            <div class="relative">
                                <i class="ph-bold ph-drop absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                <input type="number" step="0.01" name="litres" required placeholder="0.00" class="w-full pl-12 p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold font-mono text-lg text-slate-700 focus:outline-none focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Current Odometer</label>
                             <div class="relative">
                                <i class="ph-bold ph-gauge absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                <input type="number" name="odometer" required placeholder="0" class="w-full pl-12 p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold font-mono text-lg text-slate-700 focus:outline-none focus:border-amber-400 focus:ring-4 focus:ring-amber-50 transition-all">
                            </div>
                             <p class="text-[10px] text-slate-400 mt-1 italic pl-1 result-odo-hint">* Recorded for log only. Does not update vehicle odometer.</p>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 text-white rounded-xl font-bold text-lg shadow-lg hover-lift flex items-center justify-center gap-2 transition-all mt-4" style="background: var(--gradient-warning);">
                        <i class="ph-bold ph-check-circle"></i> Submit Entry
                    </button>
                </form>
            </div>
            `;
        };

        window.toggleMaint = (btn, type) => {
            const isActive = btn.classList.contains('active');

            if (isActive) {
                // Deactivate
                btn.classList.remove('active');
                btn.className = "flex-1 py-3 px-2 rounded-xl border border-slate-200 bg-white text-slate-500 font-medium transition-all hover:bg-slate-50";
                if (btn.dataset.value === 'Other') {
                    document.getElementById(type + 'OtherInput').classList.add('hidden');
                }
            } else {
                // Activate
                btn.classList.add('active');
                btn.className = "flex-1 py-3 px-2 rounded-xl border font-bold text-sm transition-all bg-green-50 border-green-500 text-green-700 shadow-sm ring-1 ring-green-500 active";
                if (btn.dataset.value === 'Other') {
                    document.getElementById(type + 'OtherInput').classList.remove('hidden');
                    document.getElementById(type + 'OtherInput').focus();
                }
            }
        };

        window.renderMaintenance = () => {
            const userBranch = state.user?.branch || 'All';
            const vehicles = (state.vehicles || []).filter(v => v.branch === userBranch);
            const today = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().split('T')[0];
            const btnClass = "flex-1 py-3 px-2 rounded-xl border border-slate-200 bg-white text-slate-500 font-medium transition-all hover:bg-slate-50";

            return `
            <div class="animate-fade-in pb-24">
                 <div class="glass-strong rounded-2xl overflow-hidden mb-6" style="box-shadow: var(--shadow-lg);">
                    <div class="p-6 relative overflow-hidden" style="background: var(--gradient-danger);">
                        <div class="absolute right-0 top-0 p-4 opacity-20"><i class="ph-fill ph-wrench text-6xl text-white"></i></div>
                        <h2 class="text-2xl font-bold text-white mb-1">Maintenance</h2>
                        <p class="text-red-100 text-sm">Report repairs & service</p>
                    </div>
                </div>

                <form onsubmit="return submitMaintenance(event)" class="space-y-6">
                    <div class="glass p-6 rounded-2xl" style="box-shadow: var(--shadow-sm);">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Select Vehicle</label>
                        <div class="relative">
                            <select name="vehicleNumber" required class="w-full p-4 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 appearance-none focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all">
                                <option value="">Choose Vehicle...</option>
                                ${vehicles.map(v => `<option value="${v.vehicleNumber || v.number}">${v.vehicleNumber || v.number} (${v.make || 'Truck'})</option>`).join('')}
                            </select>
                            <i class="ph-bold ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-2xl space-y-5" style="box-shadow: var(--shadow-sm);">
                        <!-- General Maintenance -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">General Maintenance</label>
                            <div class="flex flex-wrap gap-2" id="general-opts">
                                ${['AdBlue', 'Service', 'Breakdown', 'Washing', 'Greasing', 'Other'].map(item => `
                                    <button type="button" onclick="toggleMaint(this, 'general')" data-value="${item}" class="${btnClass}">${item}</button>
                                `).join('')}
                            </div>
                            <input type="text" id="generalOtherInput" name="generalOther" placeholder="Specify other general issue..." class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl hidden focus:border-red-400 focus:outline-none">
                        </div>

                        <!-- Tyre Maintenance -->
                        <div class="pt-2 border-t border-slate-100">
                             <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 mt-2">Tyre Maintenance</label>
                            <div class="flex flex-wrap gap-2" id="tyre-opts">
                                ${['Puncture', 'Flap Replace', 'Powder Coating', 'Wheel Alignment', 'Other'].map(item => `
                                    <button type="button" onclick="toggleMaint(this, 'tyre')" data-value="${item}" class="${btnClass}">${item}</button>
                                `).join('')}
                            </div>
                            <input type="text" id="tyreOtherInput" name="tyreOther" placeholder="Specify other tyre issue..." class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl hidden focus:border-red-400 focus:outline-none">
                        </div>
                    </div>

                    <div class="glass p-6 rounded-2xl space-y-5" style="box-shadow: var(--shadow-sm);">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Details</label>
                            <div class="space-y-3">
                                <div class="relative">
                                    <i class="ph-bold ph-currency-inr absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input type="number" name="price" placeholder="Price (Rs.)" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all">
                                </div>
                                <div class="relative">
                                    <i class="ph-bold ph-map-pin absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input type="text" name="place" required placeholder="Place / Workshop Name" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all">
                                </div>
                                <div class="relative">
                                    <i class="ph-bold ph-calendar-blank absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input type="date" name="date" required value="${today}" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all">
                                </div>
                                <div class="relative">
                                    <i class="ph-bold ph-gauge absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                    <input type="text" name="odometer" placeholder="Odometer Reading" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all">
                                </div>
                                <div>
                                    <textarea name="remarks" placeholder="Remarks / Notes (Optional)" rows="3" class="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-medium text-slate-700 focus:outline-none focus:border-red-400 focus:ring-4 focus:ring-red-50 transition-all"></textarea>
                                </div>

                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 text-white rounded-xl font-bold text-lg shadow-lg hover-lift flex items-center justify-center gap-2 transition-all mt-4" style="background: var(--gradient-danger);">
                        <i class="ph-bold ph-check-circle"></i> Submit Report
                    </button>
                </form>
            </div>
            `;
        };

        window.submitMaintenance = async (e) => {
            e.preventDefault();
            if (!state.user) return;

            const formData = new FormData(e.target);

            // Gather selected buttons
            const generalBtns = Array.from(document.querySelectorAll('#general-opts button.active'));
            const general = generalBtns.map(b => b.dataset.value);
            if (general.includes('Other')) {
                const otherIdx = general.indexOf('Other');
                const otherText = document.getElementById('generalOtherInput').value;
                if (otherText) general[otherIdx] = `Other: ${otherText} `;
            }

            const tyreBtns = Array.from(document.querySelectorAll('#tyre-opts button.active'));
            const tyre = tyreBtns.map(b => b.dataset.value);
            if (tyre.includes('Other')) {
                const otherIdx = tyre.indexOf('Other');
                const otherText = document.getElementById('tyreOtherInput').value;
                if (otherText) tyre[otherIdx] = `Other: ${otherText} `;
            }

            if (general.length === 0 && tyre.length === 0) {
                alert("Please select at least one maintenance item.");
                return false;
            }

            const data = {
                vehicleNumber: formData.get('vehicleNumber'),
                general: general,
                tyre: tyre,
                place: formData.get('place'),
                date: formData.get('date'),
                price: formData.get('price'),
                odometer: formData.get('odometer'),
                remarks: formData.get('remarks'),

                driverName: state.user.name,
                driverId: state.user.id || state.user.phone,
                timestamp: serverTimestamp(),
                createdAt: serverTimestamp()
            };

            try {
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
                btn.disabled = true;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_maintenance_logs'), data);

                alert("Maintenance report saved successfully!");
                e.target.reset();
                // Reset buttons
                document.querySelectorAll('#general-opts button, #tyre-opts button').forEach(b => {
                    b.classList.remove('active');
                    b.className = "flex-1 py-3 px-2 rounded-xl border border-slate-200 bg-white text-slate-500 font-medium transition-all hover:bg-slate-50";
                });
                document.getElementById('generalOtherInput').classList.add('hidden');
                document.getElementById('tyreOtherInput').classList.add('hidden');

                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error("Error logging maintenance:", error);
                alert("Failed to save report. Please try again.");
                const btn = e.target.querySelector('button[type="submit"]');
                btn.innerHTML = '<i class="ph-bold ph-check-circle"></i> Submit Report';
                btn.disabled = false;
            }
            return false;
        };

        window.openFineDetails = (fineId) => {
            const fine = state.policeFines.find(f => f.id === fineId) || state.tollLogs.find(t => t.id === fineId);
            if (!fine) return;
            state.viewFine = fine;
            state.modal = 'fineDetails';
            render();
        };

        const renderFineDetailsModal = () => {
            const fine = state.viewFine;
            if (!fine) return '';
            const isPolice = fine.type === 'police' || fine.dataType === 'fine';

            return `
            <div class="fixed inset-0 z-[60] flex items-center justify-center p-4">
                <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="state.modal=null; render()"></div>
                <div class="relative w-full max-w-sm bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-2xl scale-in">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 rounded-full ${isPolice ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} mx-auto flex items-center justify-center mb-3">
                            <i class="ph-fill ${isPolice ? 'ph-siren' : 'ph-road-horizon'} text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">${isPolice ? 'Police Fine Details' : 'Toll Details'}</h3>
                        <p class="text-slate-500 text-sm">${formatDate(fine.timestamp)} • ${formatTime(fine.timestamp)}</p>
                    </div>

                    <div class="space-y-4 mb-8">
                        <div class="bg-slate-50 dark:bg-slate-900 rounded-2xl p-4 border border-slate-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Amount</div>
                             <div class="text-2xl font-bold text-slate-800 dark:text-white">₹${fine.amount}</div>
                        </div>
                        
                         <div class="bg-slate-50 dark:bg-slate-900 rounded-2xl p-4 border border-slate-100 dark:border-slate-700">
                             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Status</div>
                             <div class="flex items-center gap-2">
                                <span class="w-2.5 h-2.5 rounded-full ${fine.status === 'Approved' ? 'bg-green-500' : 'bg-amber-500'}"></span>
                                <span class="font-bold text-slate-700 dark:text-slate-200">${fine.status || 'Pending Approval'}</span>
                             </div>
                             ${fine.adminComments ? `<div class="mt-2 text-sm text-slate-500 pt-2 border-t border-slate-200">${fine.adminComments}</div>` : ''}
                        </div>
                    </div>

                    <button onclick="state.modal=null; render()" class="w-full py-3.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition-colors">
                        Close
                    </button>
                </div>
            </div>`;
        };

        window.renderExpenses = () => {
            if (!state.expensesMode) {
                return `
                <div class="animate-fade-in pb-24 pt-6 px-4">
                        <div class="glass-strong rounded-2xl p-6 mb-8 text-center" style="box-shadow: var(--shadow-md);">
                            <div class="w-16 h-16 rounded-full bg-blue-50 text-blue-600 mx-auto flex items-center justify-center mb-3">
                                <i class="ph-fill ph-wallet text-3xl"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800">Expenses</h2>
                            <p class="text-slate-500 text-sm">Log fines and tolls</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="state.expensesMode='police'; render()" class="w-full p-5 rounded-2xl bg-white border border-slate-200 shadow-sm flex items-center gap-4 hover:shadow-md transition-all active:scale-95 group">
                                <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="ph-fill ph-siren text-2xl"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <h3 class="font-bold text-lg text-slate-800">Police Fine</h3>
                                    <p class="text-xs text-slate-500">Traffic violations & challans</p>
                                </div>
                                <i class="ph-bold ph-caret-right text-slate-300"></i>
                            </button>

                            <button onclick="state.expensesMode='toll'; render()" class="w-full p-5 rounded-2xl bg-white border border-slate-200 shadow-sm flex items-center gap-4 hover:shadow-md transition-all active:scale-95 group">
                                <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                                    <i class="ph-fill ph-road-horizon text-2xl"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <h3 class="font-bold text-lg text-slate-800">Toll Gate</h3>
                                    <p class="text-xs text-slate-500">Toll payments (Hidden Mode)</p>
                                </div>
                                <i class="ph-bold ph-caret-right text-slate-300"></i>
                            </button>
                        </div>
                </div>
            </div>
            `;
            }

            const isPolice = state.expensesMode === 'police';
            const today = new Date(new Date().getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16);

            return `
            <div class="animate-fade-in pb-24">
                <div class="p-4 flex items-center gap-3">
                    <button onclick="state.expensesMode=null; render()" class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-slate-600 active:scale-90 transition-transform"><i class="ph-bold ph-arrow-left"></i></button>
                    <h2 class="text-xl font-bold text-slate-800">${isPolice ? 'Police Fine' : 'Toll Gate'}</h2>
                </div>

                <div class="glass-strong rounded-2xl overflow-hidden mx-4 mb-6" style="box-shadow: var(--shadow-lg);">
                    <div class="p-6 relative overflow-hidden" style="background: ${isPolice ? 'var(--gradient-danger)' : 'var(--gradient-primary)'};">
                        <div class="absolute right-0 top-0 p-4 opacity-20"><i class="ph-fill ${isPolice ? 'ph-siren' : 'ph-road-horizon'} text-6xl text-white"></i></div>
                        <h2 class="text-2xl font-bold text-white mb-1">${isPolice ? 'New Challan' : 'Toll Entry'}</h2>
                        <p class="${isPolice ? 'text-red-100' : 'text-blue-100'} text-sm">${isPolice ? 'Enter fine details' : 'Record toll expense'}</p>
                    </div>
                </div>

                <form onsubmit="return submitExpense(event, '${state.expensesMode}')" class="space-y-6 px-4">
                    <div class="glass p-6 rounded-2xl space-y-5" style="box-shadow: var(--shadow-sm);">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Date & Time</label>
                            <div class="relative">
                                <i class="ph-bold ph-calendar-blank absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                <input type="datetime-local" name="date" required value="${today}" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-${isPolice ? 'red' : 'blue'}-400 focus:ring-4 focus:ring-${isPolice ? 'red' : 'blue'}-50 transition-all">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Amount (₹)</label>
                            <div class="relative">
                                <i class="ph-bold ph-currency-inr absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl"></i>
                                <input type="number" name="amount" required placeholder="0" class="w-full pl-12 p-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:border-${isPolice ? 'red' : 'blue'}-400 focus:ring-4 focus:ring-${isPolice ? 'red' : 'blue'}-50 transition-all">
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl mb-2">
                             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Linked Trip</div>
                             <div class="font-bold text-slate-700 flex items-center gap-2">
                                <i class="ph-fill ph-map-pin text-purple-500"></i>
                                ${state.viewTrip ? `${state.viewTrip.pickupLocation} <i class="ph-bold ph-arrow-right text-xs text-slate-400"></i> ${state.viewTrip.dropLocation}` : (state.activeTrip ? `${state.activeTrip.pickupLocation} <i class="ph-bold ph-arrow-right text-xs text-slate-400"></i> ${state.activeTrip.dropLocation}` : 'General Entry')}
                             </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-4 text-white rounded-xl font-bold text-lg shadow-lg hover-lift flex items-center justify-center gap-2 transition-all mt-4" style="background: ${isPolice ? 'var(--gradient-danger)' : 'var(--gradient-primary)'};">
                        <i class="ph-bold ph-check-circle"></i> Save Entry
                    </button>
                </form>
                </div>
            </div>
            `;
        };

        window.submitExpense = async (e, type) => {
            e.preventDefault();
            if (!state.user) return;

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const collectionName = type === 'police' ? 'ams_police_fines' : 'ams_toll_logs';

            try {
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
                btn.disabled = true;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', collectionName), {
                    ...data,
                    driverName: state.user.name,
                    driverId: state.user.id || state.user.phone,
                    branch: state.user.branch || 'Unknown',
                    tripId: state.viewTrip?.id || state.activeTrip?.id || null,
                    pickup: state.viewTrip?.pickupLocation || state.activeTrip?.pickupLocation || null,
                    drop: state.viewTrip?.dropLocation || state.activeTrip?.dropLocation || null,
                    vehicleNumber: state.viewTrip?.vehicleNumber || state.activeTrip?.vehicleNumber || (state.viewTrip?.truckNumber || null),
                    type: type,
                    timestamp: serverTimestamp(),
                    createdAt: serverTimestamp()
                });

                alert("Entry saved successfully!");
                e.target.reset();
                state.expensesMode = null; // Go back to menu
                render();

            } catch (error) {
                console.error("Error logging expense:", error);
                alert("Failed to save entry. Please try again.");
                const btn = e.target.querySelector('button[type="submit"]');
                btn.innerHTML = '<i class="ph-bold ph-check-circle"></i> Save Entry';
                btn.disabled = false;
            }
            return false;
        };

        window.submitFuel = async (e) => {
            e.preventDefault();
            if (!state.user) return;

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                // Show loading state (optional UI enhancement)
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin"></i> Saving...';
                btn.disabled = true;

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ams_fuel_logs'), {
                    ...data,
                    driverName: state.user.name,
                    driverId: state.user.id || state.user.phone,
                    // date: taken from form data
                    timestamp: serverTimestamp(),
                    createdAt: serverTimestamp()
                });

                alert("Fuel entry recorded successfully!");
                e.target.reset(); // Clear form

                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error("Error logging fuel:", error);
                alert("Failed to save fuel log. Please try again.");
                const btn = e.target.querySelector('button[type="submit"]');
                btn.innerHTML = '<i class="ph-bold ph-check-circle"></i> Submit Entry';
                btn.disabled = false;
            }
            return false;
        };

        const renderAttendance = () => `<div class="space-y-6"><div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div class="flex justify-between items-center mb-2"><h2 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="ph-fill ph-calendar-check text-blue-600"></i> Report</h2></div>${renderCalendar(state.monthlyAttendance, state.trips)}</div><button type="button" onclick="state.modal='applyLeave'; render()" class="w-full py-4 bg-amber-500 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2"><i class="ph-bold ph-file-text"></i> Apply for Leave</button><div><h3 class="text-sm font-bold text-slate-500 uppercase mb-3">Requests</h3><div class="space-y-3">${state.leaveRequests.map(r => `<div class="bg-white border p-3 rounded-xl flex justify-between items-center"><div><div class="text-sm font-bold text-slate-700">${r.startDate} <span class="text-slate-400">to</span> ${r.endDate}</div><div class="text-xs text-slate-500 italic">${r.reason}</div></div><div><span class="px-2 py-1 rounded-lg text-xs font-bold ${r.status === 'approved' ? 'bg-green-100 text-green-700' : (r.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700')}">${r.status.toUpperCase()}</span></div></div>`).join('')}</div></div></div>`;

        const renderModals = () => {
            if (!state.modal) return '';
            let content = '';
            if (state.modal === 'termsConditions') {
                const td = state.termsData || {};
                content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-warning);">
                        <i class="ph-fill ph-clipboard-text text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2" style="background: var(--gradient-warning); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Terms & Conditions</h3>
                    <p class="text-slate-600 text-sm">Tap to confirm status</p>
                </div>
                <div class="space-y-5 mb-6">
                    <button type="button" onclick="updateTerms('beltCondition', !state.termsData.beltCondition)" class="w-full p-4 rounded-xl flex items-center gap-4 transition-all ${td.beltCondition ? 'bg-green-100 border-2 border-green-500 text-green-800' : 'bg-slate-50 border-2 border-slate-200 text-slate-500'}" style="box-shadow: var(--shadow-sm);">
                        <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${td.beltCondition ? 'border-green-600 bg-green-600 text-white' : 'border-slate-300'}">
                            ${td.beltCondition ? '<i class="ph-bold ph-check text-sm"></i>' : ''}
                        </div>
                        <span class="font-bold text-lg">Belt Condition Checked</span>
                    </button>

                    <div class="space-y-4">
                        ${['deliveryChallan', 'invoiceCopy', 'eWayBill', 'lorryReceipt'].map(field => `
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-bold text-slate-700 capitalize">${field.replace(/([A-Z])/g, ' $1').trim()}</label>
                                    ${td[field] ? `<span class="text-xs font-bold px-2 py-0.5 rounded ${td[field] === 'Yes' ? 'bg-green-100 text-green-700' : (td[field] === 'No' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600')}">${td[field]}</span>` : ''}
                                </div>
                                <div class="grid grid-cols-3 gap-2">
                                    ${['Yes', 'No', 'NA'].map(opt => `
                                        <button type="button" onclick="updateTerms('${field}', '${opt}')" class="py-3 px-2 rounded-lg text-sm font-bold border-2 transition-all ${td[field] === opt ? (opt === 'Yes' ? 'border-green-500 bg-green-50 text-green-700' : (opt === 'No' ? 'border-red-500 bg-red-50 text-red-700' : 'border-slate-400 bg-slate-100 text-slate-700')) : 'border-slate-100 bg-white text-slate-400 hover:border-slate-200'}">
                                            ${opt}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                    <button type="button" onclick="acceptTerms()" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-warning); box-shadow: var(--shadow-md);">I Agree</button>
                </div>`;
            }
            else if (state.modal === 'startTrip') content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-primary);">
                        <i class="ph-fill ph-gauge text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Start Odometer</h3>
                    ${state.isContinuedSession ? '<p class="text-xs text-purple-600 mt-2 font-semibold"><i class="ph-bold ph-check"></i> Auto-filled from last trip</p>' : '<p class="text-xs text-slate-500 mt-2">Auto-filled from vehicle data</p>'}
                </div>
            <input type="number" id="start-odo" readonly value="${state.isContinuedSession ? (state.lastTripData?.endOdo || '') : getVehicleOdo(state.form.truck)}" class="w-full p-5 border-2 border-purple-200 rounded-2xl text-3xl text-center mb-6 font-bold bg-slate-50 text-slate-500 focus:outline-none cursor-not-allowed transition-all" placeholder="0" style="box-shadow: var(--shadow-sm);">
                <div class="flex gap-3">
                    <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                    <button type="button" onclick="confirmStartTrip()" class="flex-1 py-3 text-white rounded-xl font-bold btn-gradient" style="box-shadow: var(--shadow-md);">Confirm</button>
                </div>`;
            else if (state.modal === 'stopTrip') content = `
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-danger);">
                        <i class="ph-fill ph-stop-circle text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold" style="background: var(--gradient-danger); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">End Odometer</h3>
                </div>
                <input type="number" id="end-odo" class="w-full p-5 border-2 border-red-200 rounded-2xl text-3xl text-center mb-6 font-bold" placeholder="123456" autofocus onkeydown="if(['e','E','+','-','.'].includes(event.key)) event.preventDefault()" style="box-shadow: var(--shadow-sm);">
                    <div class="flex gap-3">
                        <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                        <button type="button" onclick="confirmStopTrip()" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-danger); box-shadow: var(--shadow-md);">Stop Trip</button>
                    </div>`;
            else if (state.modal === 'postTrip') content = `
                    <div class="text-center">
                        ${state.viewTrip ? `
                    <div class="w-16 h-16 rounded-full mx-auto mb-3 flex items-center justify-center shadow-lg shadow-purple-200" style="background: var(--gradient-primary);">
                        <i class="ph-bold ph-list text-3xl text-white"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">Trip Options</h2>
                    <p class="text-xs text-slate-500 mb-6 font-medium">Manage this trip</p>
                    ` : `
                    <div class="w-20 h-20 rounded-full mx-auto mb-4 flex items-center justify-center animate-bounce-slow" style="background: var(--gradient-green);">
                        <i class="ph-bold ph-check text-4xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Trip Completed!</h2>
                    <p class="text-slate-500 mb-6">What's next?</p>
                    `}

                        ${(!state.viewTrip || state.isLatestTrip) ? `
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button type="button" onclick="handleContinueSession()" class="group relative overflow-hidden p-4 rounded-2xl shadow-lg transition-all hover:scale-[1.02] active:scale-95 text-left" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                            <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/3 -translate-y-1/3"><i class="ph-fill ph-arrow-clockwise text-6xl text-white"></i></div>
                            <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2"><i class="ph-bold ph-arrow-clockwise text-xl text-white"></i></div>
                            <div class="font-bold text-white leading-tight">Continue<br>Trip</div>
                        </button>
                        <button type="button" onclick="handleReturnTrip()" class="group relative overflow-hidden p-4 rounded-2xl shadow-lg transition-all hover:scale-[1.02] active:scale-95 text-left" style="background: linear-gradient(135deg, #f43f5e 0%, #e11d48 100%);">
                            <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/3 -translate-y-1/3"><i class="ph-fill ph-arrows-left-right text-6xl text-white"></i></div>
                            <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mb-2"><i class="ph-bold ph-arrows-left-right text-white text-xl"></i></div>
                            <div class="font-bold text-white leading-tight">Return<br>Trip</div>
                        </button>
                    </div>
                    ` : ''}

                        ${state.viewTrip ? `
                    <div class="mb-6">
                        <div class="flex items-center gap-2 mb-3 px-1">
                            <div class="h-px flex-1 bg-slate-100"></div>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Report Expense</span>
                            <div class="h-px flex-1 bg-slate-100"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="state.driverTab='expenses'; state.expensesMode='police'; state.modal=null; render()" class="p-3.5 rounded-xl bg-red-50 text-red-600 border border-red-100 flex items-center justify-center gap-2 font-bold text-sm hover:bg-red-100 transition-colors shadow-sm active:scale-95"><i class="ph-bold ph-siren text-lg"></i> Police Fine</button>
                            <button type="button" onclick="state.driverTab='expenses'; state.expensesMode='toll'; state.modal=null; render()" class="p-3.5 rounded-xl bg-blue-50 text-blue-600 border border-blue-100 flex items-center justify-center gap-2 font-bold text-sm hover:bg-blue-100 transition-colors shadow-sm active:scale-95"><i class="ph-bold ph-road-horizon text-lg"></i> Toll Gate</button>
                        </div>
                    </div>
                    ` : ''}

                        ${(!state.viewTrip || state.isLatestTrip) ? `
                    <button type="button" onclick="handleEndDuty()" class="w-full py-4 text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 hover:brightness-110 active:scale-95 transition-all mb-4" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <i class="ph-bold ph-check-circle text-xl"></i> End Trip
                    </button>
                    ` : ''}

                        ${state.viewTrip ? `
                    <div class="grid grid-cols-2 gap-3">
                         <button type="button" onclick="state.modal='viewTrip'; render()" class="w-full py-3.5 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all flex items-center justify-center gap-2"><i class="ph-bold ph-eye"></i> View Details</button>
                         <button type="button" onclick="state.modal=null; render()" class="w-full py-3.5 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all">Close</button>
                    </div>
                   ` : `<button type="button" onclick="state.modal='viewTrip'; render()" class="w-full py-3 glass rounded-xl font-bold text-slate-600 hover-lift"><i class="ph-bold ph-eye"></i> View Details</button>`}
                    </div>`;
            else if (state.modal === 'applyLeave') content = `
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-warning);">
                            <i class="ph-fill ph-calendar-x text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold" style="background: var(--gradient-warning); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Apply for Leave</h3>
                    </div>
                    <form onsubmit="return submitLeave(event)" class="space-y-5">
                        <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">From Date</label><input type="date" id="leave-start" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1" required style="box-shadow: var(--shadow-sm);"></div>
                        <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">To Date</label><input type="date" id="leave-end" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1" required style="box-shadow: var(--shadow-sm);"></div>
                        <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Reason</label><textarea id="leave-reason" class="w-full p-4 border-2 border-slate-200 rounded-xl h-24 mt-1" required style="box-shadow: var(--shadow-sm);"></textarea></div>
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                            <button type="submit" class="flex-1 py-3 text-white rounded-xl font-bold" style="background: var(--gradient-warning); box-shadow: var(--shadow-md);">Submit</button>
                        </div>
                    </form>`;
            else if (state.modal === 'viewTrip') {
                const t = state.viewTrip || {};
                const row = (l, v) => `<div class="flex justify-between py-2 border-b border-slate-100 last:border-0"><span class="text-xs font-bold text-slate-400 uppercase">${l}</span><span class="text-sm font-bold text-slate-700 text-right">${v || '-'}</span></div>`;
                content = `
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center bg-blue-100 text-blue-600">
                            <i class="ph-fill ph-read-cv-logo text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800">Trip Details</h3>
                        <p class="text-xs text-slate-500 mt-1">ID: ${t.id}</p>
                    </div>
                    <div class="bg-slate-50 rounded-2xl p-5 mb-4 border border-slate-200">
                        <div class="text-center mb-3 pb-3 border-b border-slate-200">
                            <h2 class="text-2xl font-bold text-indigo-600 font-mono">${t.truckNumber}</h2>
                            <span class="text-[10px] font-bold uppercase bg-white px-2 py-1 rounded shadow-sm text-slate-500 border border-slate-100">${t.tripType || 'TVS'}</span>
                        </div>
                        <div class="space-y-0.5">
                            ${row('Date', t.date)}
                            ${row('Status', `<span class="uppercase font-bold text-[10px] px-1.5 py-0.5 rounded ${t.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">${t.status}</span>`)}
                            ${row('Driver', t.driverName)}
                            ${row('Vehicle No', t.vehicleNumber)}
                            ${row('Start Odo', t.startOdo)}
                            ${row('End Odo', t.endOdo)}
                            ${row('Pickup', t.pickupLocation)}
                            ${row('Drop', t.dropLocation)}
                        </div>
                    </div>
                    <button type="button" onclick="state.modal='postTrip'; render()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover-lift">Back to Options</button>
                    `;
            }
            else if (state.modal === 'editTrip') {
                const t = state.editTrip || {};
                content = `
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 rounded-2xl mx-auto mb-4 flex items-center justify-center" style="background: var(--gradient-primary);">
                            <i class="ph-fill ph-pencil-simple text-3xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold" style="background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Edit Trip</h3>
                        <p class="text-xs text-slate-500 mt-2">Correcting trip details for ${t.truckNumber || 'Vehicle'}</p>
                    </div>
                    <form onsubmit="return saveTripEdit(event)" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Start Odo</label><input type="number" name="startOdo" value="${t.startOdo}" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1 font-bold font-mono" required style="box-shadow: var(--shadow-sm);"></div>
                            <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">End Odo</label><input type="number" name="endOdo" value="${t.endOdo}" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1 font-bold font-mono" required style="box-shadow: var(--shadow-sm);"></div>
                        </div>
                        ${t.tripCategory === 'Break Down' ? `
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">Start Location</label><input type="text" name="pickupLocation" value="${t.pickupLocation}" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1" required></div>
                         <div><label class="text-xs font-bold text-slate-600 uppercase tracking-wider">End Location</label><input type="text" name="dropLocation" value="${t.dropLocation}" class="w-full p-4 border-2 border-slate-200 rounded-xl mt-1" required></div>
                    </div>` : ''}
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="state.modal=null; render()" class="flex-1 py-3 glass rounded-xl font-bold text-slate-700 hover-lift" style="box-shadow: var(--shadow-sm);">Cancel</button>
                            <button type="submit" class="flex-1 py-3 text-white rounded-xl font-bold btn-gradient" style="box-shadow: var(--shadow-md);">Save</button>
                        </div>
                    </form>`;
            }

            if (state.modal === 'fineDetails') {
                return renderFineDetailsModal();
            }

            return `<div class="fixed inset-0 z-40 flex items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);"><div class="glass-strong rounded-3xl p-8 w-full max-w-md" style="box-shadow: var(--shadow-xl);">${content}</div></div>`;
        };

        window.render = () => {
            modalDiv.innerHTML = renderModals();
            if (!state.user) { appDiv.innerHTML = renderLogin(); return; }
            appDiv.innerHTML = `
                    <header class="text-white p-5 sticky top-0 z-10 flex justify-between items-center glass-dark backdrop-blur-md" style="background: var(--gradient-blue); box-shadow: var(--shadow-lg);">
                        <div class="flex items-center gap-3">
                            <div class="glass-dark p-2.5 rounded-xl">
                                <i class="ph-fill ph-truck text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="font-bold text-xl">Driver Panel</h1>
                                <p class="text-xs text-blue-100 font-medium opacity-90 flex items-center gap-1"><i class="ph-bold ph-user"></i> ${state.user.name}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl glass-dark flex items-center justify-center hover:bg-white/20 transition-all active:scale-95">
                                <i class="ph-fill ${state.darkMode ? 'ph-sun text-amber-300' : 'ph-moon-stars text-blue-100'} text-xl"></i>
                            </button>
                            <button onclick="handleLogout()" class="w-10 h-10 rounded-xl glass-dark flex items-center justify-center hover:bg-red-500/20 transition-all active:scale-95">
                                <i class="ph-bold ph-power text-xl"></i>
                            </button>
                        </div>
                    </header>

                    <main class="max-w-3xl mx-auto p-4 w-full min-h-screen pb-24 transition-colors duration-300 dark:bg-slate-900">
                        ${state.driverTab === 'home' ? renderHome() : (state.driverTab === 'attendance' ? renderAttendance() : (state.driverTab === 'fuel' ? renderFuel() : (state.driverTab === 'maintenance' ? renderMaintenance() : renderExpenses())))}
                    </main>

                    <nav class="fixed bottom-0 left-0 right-0 glass-strong dark:bg-slate-800/90 dark:border-t dark:border-slate-700 p-3 flex justify-around items-center z-20 pb-safe transition-all" style="box-shadow: 0 -4px 16px rgba(0,0,0,0.1);">
                        <button type="button" onclick="state.driverTab='home'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'home' ? 'scale-in' : ''}" style="${state.driverTab === 'home' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'home' ? 'color: #94a3b8;' : ''}">
                            <i class="ph-fill ph-house text-2xl"></i>
                            <span class="text-[10px] font-bold">Home</span>
                        </button>
                        <button type="button" onclick="state.driverTab='attendance'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'attendance' ? 'scale-in' : ''}" style="${state.driverTab === 'attendance' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'attendance' ? 'color: #94a3b8;' : ''}">
                            <i class="ph-fill ph-calendar-check text-2xl"></i>
                            <span class="text-[10px] font-bold">Status</span>
                        </button>
                        <button type="button" onclick="state.driverTab='fuel'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'fuel' ? 'scale-in' : ''}" style="${state.driverTab === 'fuel' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'fuel' ? 'color: #94a3b8;' : ''}">
                            <i class="ph-fill ph-gas-pump text-2xl"></i>
                            <span class="text-[10px] font-bold">Fuel</span>
                        </button>
                        <button type="button" onclick="state.driverTab='maintenance'; render()" class="p-3 rounded-2xl flex flex-col items-center gap-1 w-24 transition-all ${state.driverTab === 'maintenance' ? 'scale-in' : ''}" style="${state.driverTab === 'maintenance' ? 'background: var(--gradient-primary); color: white; box-shadow: var(--shadow-md);' : ''} ${state.driverTab !== 'maintenance' ? 'color: #94a3b8;' : ''}">
                            <i class="ph-fill ph-wrench text-2xl"></i>
                            <span class="text-[10px] font-bold">Maint.</span>
                        </button>

                    </nav>`;

            // Re-apply dark mode to root if needed (safety check)
            if (state.darkMode) document.documentElement.classList.add('dark');
        };

        // COMPREHENSIVE AUTO-REFRESH PREVENTION

        // 1. Prevent all form submissions from refreshing the page
        // 1. Prevent all form submissions from refreshing the page
        document.addEventListener('submit', (e) => {
            console.log('Form submission prevented');
            e.preventDefault();
            // Do NOT stop propagation, otherwise specific form handlers like handleLogin won't run
            // e.stopPropagation(); 
            return false;
        }, true);

        // 2. Prevent all link clicks from navigating
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        // 3. Prevent any accidental page navigation
        window.addEventListener('beforeunload', (e) => {
            // Only prevent if user is logged in and has active data
            if (state.user && state.activeTrip) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // 4. Prevent browser back button from refreshing
        window.history.pushState(null, '', window.location.href);
        window.addEventListener('popstate', (e) => {
            window.history.pushState(null, '', window.location.href);
            e.preventDefault();
            return false;
        });

        // 5. Log any page load to debug
        console.log('Driver App loaded at:', new Date().toISOString());
        let renderCount = 0;
        const originalRender = window.render;
        let globalRenderTimeout = null;
        window.render = function () {
            if (globalRenderTimeout) clearTimeout(globalRenderTimeout);
            globalRenderTimeout = setTimeout(() => {
                renderCount++;
                console.log('Render called #' + renderCount + ' (Debounced)');
                originalRender.apply(this, arguments);
                globalRenderTimeout = null;
            }, 50);
        };

        initAuth();
    </script>
</body>

</html>